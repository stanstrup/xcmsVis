# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is an R package project named `xcmsVis`, a parallel package to XCMS that provides ggplot2 implementations of XCMS plotting functions for modern, interactive visualizations.

## Project Task Management

**IMPORTANT**: This project uses a structured task management system to minimize token usage:

- **`instructions.md`**: Contains ONLY current/active tasks. Keep this file as lightweight as possible.
- **`completed_tasks.md`**: Archive of all completed tasks with detailed documentation.
- **`future_tasks.md`**: Long-term development roadmap and planned features.

When working on tasks:
1. Check `instructions.md` for current work
2. Move completed tasks to `completed_tasks.md` with details
3. Keep `instructions.md` minimal to reduce token consumption
4. Reference other files for context rather than duplicating information

## R Package Development Commands

### Package Setup and Building
```r
# Install development dependencies
install.packages(c("devtools", "roxygen2", "testthat", "usethis"))

# Build package documentation from roxygen comments
devtools::document()

# Install the package locally
devtools::install()

# Build package bundle
devtools::build()

# Check package (runs R CMD check)
devtools::check()
```

### Testing
```r
# Run all tests
devtools::test()

# Run tests with coverage
covr::package_coverage()

# Run a specific test file
testthat::test_file("tests/testthat/test-filename.R")
```

### Development Workflow
```r
# Load package for interactive development
devtools::load_all()

# Create new function/data documentation
usethis::use_r("function_name")

# Add test file
usethis::use_test("function_name")

# Add package dependency
usethis::use_package("package_name")
```

## R Package Structure

When creating R package files, follow this structure:

- `DESCRIPTION` - Package metadata and dependencies
- `NAMESPACE` - Package namespace (auto-generated by roxygen2)
- `R/` - R source code files
- `man/` - Documentation files (auto-generated by roxygen2)
- `tests/testthat/` - Unit tests
- `vignettes/` - Long-form documentation
- `data/` - Package datasets
- `inst/` - Additional files to be installed

## Code Style

The project follows standard R package conventions:
- Use 2 spaces for indentation (configured in .Rproj file)
- Strip trailing whitespace (configured in .Rproj file)
- Auto-append newline to files (configured in .Rproj file)
- Use UTF-8 encoding

## Testing Requirements

**IMPORTANT**: All functions MUST have comprehensive tests:
- Test compatibility with both XCMSnExp and XcmsExperiment objects
- Even if examples/vignettes focus on XcmsExperiment, tests must verify XCMSnExp works
- Write tests in `tests/testthat/test-*.R` files
- Use `testthat::test_file()` to run individual test files
- Ensure all major code paths are covered

## Adding New Functions

When implementing new XCMS plotting functions:

1. Identify XCMS plotting function to implement
2. Locate source code in XCMS GitHub: https://github.com/sneumann/xcms
3. Study the function's purpose, parameters, and output
4. Implement ggplot2 version in `R/gplot*.R`
5. Add roxygen2 documentation
6. Update NAMESPACE if needed
7. Add tests in `tests/testthat/test-*.R` (REQUIRED - test both object types)
8. Add examples to vignette (focus on XcmsExperiment)
9. Update NEWS.md
10. Run `devtools::check()`
11. Move task from instructions.md to `completed_tasks.md` when done

## Key Resources

- **XCMS Repository**: https://github.com/sneumann/xcms
- **Metabonaut Tutorials**: https://github.com/rformassspectrometry/Metabonaut
- **Original Discussion**: https://github.com/sneumann/xcms/issues/551
- **Package Structure Reference**: `/mnt/c/Users/tmh331/Desktop/gits/remoteUpdater`
- **Function Reference**: `/mnt/c/Users/tmh331/Desktop/gits/_Introduction to Nutritional Metabolomics/inm-booklet/scripts/funs.R`

## Important Conventions

- Follow XCMS conventions for object types and methods
- Maintain compatibility with both XCMSnExp and xcmsExperiment objects
- Use consistent naming: `gplot*` prefix for all plotting functions
- Include tooltip text for plotly compatibility
- Write comprehensive roxygen2 documentation
- Add examples (even if marked `\dontrun`)
- When tasks are completed, move them to `completed_tasks.md`

## Git Workflow

- Default branch: `main`
- Use conventional commits (see semantic-release configuration)
- GitHub Actions will automatically:
  - Run R CMD check on push/PR
  - Deploy pkgdown site on push to main
  - Create releases via semantic-release
- Always commit with co-authorship footer when using Claude Code

## Pre-Push Checklist

**IMPORTANT**: Before pushing to GitHub, ALWAYS verify that pkgdown builds successfully:

```r
# Load all package code
devtools::load_all()

# Build pkgdown site locally
pkgdown::build_site()
```

Check for:
- No errors during site build
- All vignettes render correctly
- All function documentation displays properly
- No broken links or missing references

Only push to GitHub after confirming pkgdown builds without errors.

## Task Management

**IMPORTANT**: Do NOT start working on new tasks from instructions.md unless explicitly told to do so by the user. Wait for the user to give the go-ahead before proceeding with tasks.
