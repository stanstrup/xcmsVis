---
title: "Visualizing RT Alignment Parameters with LamaParama"
author: "xcmsVis Package"
date: today
format:
  html:
    toc: true
    toc-location: left
    code-fold: false
    theme: cosmo
vignette: >
  %\VignetteIndexEntry{Visualizing RT Alignment Parameters with LamaParama}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

```{r setup}
#| include: false
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 6,
  warning = FALSE,
  message = FALSE
)
```

# Introduction

This vignette demonstrates the `gplot()` method for `LamaParama` objects, which visualizes the retention time alignment model used in landmark-based alignment (LAMA). The function shows the relationship between observed and reference retention times, along with the fitted model (loess or GAM).

# What is LamaParama?

LamaParama (Landmark-based Alignment Parameters) is an alignment method in XCMS that uses feature groups as "landmarks" to correct retention time shifts between samples. Unlike other methods, it explicitly models the RT relationship and stores the alignment parameters for visualization and quality assessment.

# Setup

```{r libraries}
library(xcms)
library(xcmsVis)
library(ggplot2)
library(plotly)
library(faahKO)
library(MsExperiment)
library(BiocParallel)
```

# Data Preparation

We'll use the faahKO package data to demonstrate alignment visualization.

```{r load_data}
# Get example CDF files
cdf_files <- dir(system.file("cdf", package = "faahKO"),
                  recursive = TRUE, full.names = TRUE)

# Using 6 samples (3 from each group)
cdf_files <- cdf_files[c(1:3, 7:9)]

# Load data as XcmsExperiment
xdata <- readMsExperiment(
  spectraFiles = cdf_files,
  BPPARAM = SerialParam()
)

# Add sample metadata
sample_group <- rep(c("KO", "WT"), each = 3)
sampleData(xdata)$sample_name <- basename(cdf_files)
sampleData(xdata)$sample_group <- sample_group
```

## Peak Detection

```{r peak_detection}
# Detect peaks using CentWave
cwp <- CentWaveParam(
  ppm = 25,
  peakwidth = c(20, 80),
  prefilter = c(3, 100)
)

xdata <- findChromPeaks(xdata, param = cwp, BPPARAM = SerialParam())
```

## Peak Grouping (Correspondence)

Before alignment, we need to group peaks across samples to create landmarks:

```{r peak_grouping}
# Group peaks for correspondence
pdp <- PeakDensityParam(
  sampleGroups = sample_group,
  minFraction = 0.4,
  bw = 30
)

xdata <- groupChromPeaks(xdata, param = pdp)
```

# Landmark-Based Alignment

Now we can perform the landmark-based alignment:

```{r alignment}
# Create LamaParama object
lama_param <- LamaParama(
  tolerance = 50,     # m/z tolerance for matching
  method = "loess",   # fitting method (or "gam")
  span = 0.5          # loess span parameter
)

# Perform alignment
xdata_aligned <- adjustRtime(xdata, param = lama_param)
```

# Visualizing Alignment Parameters

After alignment, we can extract the LamaParama object from the process history and visualize the alignment model:

```{r extract_params}
# Extract alignment parameters from process history
proc_hist <- processHistory(xdata_aligned,
                            type = .PROCSTEP.RTIME.CORRECTION)
lama_result <- proc_hist[[length(proc_hist)]]@param
```

## Basic Alignment Plot

Each plot shows:
- **Points**: Matched peaks between the sample and reference
- **Line**: The fitted retention time correction model

```{r basic_plot}
# Plot alignment for first sample
p <- gplot(lama_result, index = 1)
p
```

The x-axis shows the observed retention times in the sample, while the y-axis shows the reference (or "Lama") retention times. The fitted line shows how retention times should be adjusted.

## Multiple Samples

We can visualize the alignment for different samples by changing the index:

```{r multiple_samples}
# Create plots for first 3 samples
p1 <- gplot(lama_result, index = 1) + ggtitle("Sample 1")
p2 <- gplot(lama_result, index = 2) + ggtitle("Sample 2")
p3 <- gplot(lama_result, index = 3) + ggtitle("Sample 3")

# Display plots
p1
p2
p3
```

## Customization

### Custom Colors

```{r custom_colors}
p_custom <- gplot(lama_result,
                  index = 1,
                  colPoints = "#E41A1C",
                  colFit = "#377EB8",
                  xlab = "Observed RT",
                  ylab = "Reference RT")
p_custom
```

### With ggplot2 Enhancements

Since the output is a ggplot object, we can add layers and customizations:

```{r ggplot_enhancements}
gplot(lama_result, index = 1) +
  ggtitle("Landmark-Based Alignment Model") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(size = 12)
  )
```

## Interactive Plots with plotly

```{r interactive}
p_interactive <- gplot(lama_result, index = 1)
ggplotly(p_interactive)
```

# Interpretation

## Good Alignment

A good alignment shows:
- Many matched points across the RT range
- Smooth fitted line (not too wiggly)
- Points closely following the fitted line
- Few outliers

## Potential Issues

Watch for:
- **Few matched points**: May indicate poor peak grouping or too strict tolerance
- **Non-smooth fit**: Could indicate overfitting or poor parameter choice
- **Many outliers**: May suggest RT shifts that are too complex for the model
- **Gaps in coverage**: Some RT regions may not be well-represented

# Comparing Alignment Methods

You can compare LamaParama with other alignment methods like Obiwarp or PeakGroups:

```{r comparison}
#| eval: false
# Compare with PeakGroups alignment
pgp <- PeakGroupsParam(
  minFraction = 0.85,
  smooth = "loess",
  span = 0.4
)

xdata_pg <- adjustRtime(xdata, param = pgp)

# Visualize differences
gplotAdjustedRtime(xdata_aligned, color_by = sample_group) +
  ggtitle("LamaParama Alignment")

gplotAdjustedRtime(xdata_pg, color_by = sample_group) +
  ggtitle("PeakGroups Alignment")
```

# Summary

The `gplot()` method for LamaParama objects provides:
- Visual assessment of alignment quality
- Diagnostic tool for parameter tuning
- Insight into RT correction model
- Publication-ready figures with ggplot2 customization

# Session Info

```{r session_info}
sessionInfo()
```
