---
title: "Visualizing Precursor Ions with gplotPrecursorIons"
author: "xcmsVis Package"
date: today
format:
  html:
    toc: true
    toc-location: left
    code-fold: false
    theme: cosmo
vignette: >
  %\VignetteIndexEntry{Visualizing Precursor Ions with gplotPrecursorIons}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

```{r setup}
#| include: false
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 6,
  warning = FALSE,
  message = FALSE
)
```

# Introduction

This vignette demonstrates the `gplotPrecursorIons()` function, which visualizes precursor ions selected for fragmentation in MS/MS (tandem mass spectrometry) experiments. This is particularly useful for:

- Assessing DDA (Data-Dependent Acquisition) performance
- Visualizing MS/MS coverage across the chromatographic run
- Quality control of MS/MS experiments
- Understanding which compounds were fragmented

# What are Precursor Ions?

In MS/MS experiments, the mass spectrometer:
1. Performs MS1 scans to detect all ions
2. Selects specific ions (precursors) based on criteria (intensity, exclusion lists, etc.)
3. Fragments these precursors and records MS2 spectra

The `gplotPrecursorIons()` function plots where and which precursor ions were selected across the LC-MS run.

# Setup

```{r libraries}
library(xcmsVis)
library(MsExperiment)
library(ggplot2)
library(plotly)
library(msdata)
```

# Loading DDA Data

We'll use example DDA data from the msdata package:

```{r load_data}
# Load DDA MS/MS data
fl <- system.file("TripleTOF-SWATH", "PestMix1_DDA.mzML",
                  package = "msdata")

pest_dda <- readMsExperiment(fl)

# Check data structure
pest_dda
```

# Basic Precursor Ion Visualization

## Default Plot

```{r basic_plot}
p <- gplotPrecursorIons(pest_dda)
p
```

The plot shows:
- **X-axis**: Retention time when MS2 spectrum was acquired
- **Y-axis**: m/z of the precursor ion selected for fragmentation
- **Points**: Each precursor ion

## Interpretation

From this plot, you can see:
- **Distribution of MS/MS events** across the chromatographic run
- **m/z range** of fragmented ions
- **Density patterns** - where fragmentation was most active
- **Coverage gaps** - RT or m/z regions without MS/MS data

# Customization

## Custom Colors and Symbols

```{r custom_colors}
p_custom <- gplotPrecursorIons(
  pest_dda,
  pch = 16,                    # filled circle
  col = "#E41A1C",             # point color
  bg = "#E41A1C80",            # background (for pch 21-25)
  xlab = "Retention Time (s)",
  ylab = "Precursor m/z"
)

p_custom
```

## Different Point Shapes

```{r point_shapes}
# Hollow circles
p1 <- gplotPrecursorIons(pest_dda, pch = 1, col = "black") +
  ggtitle("Hollow Circles (pch = 1)")

# Filled circles
p2 <- gplotPrecursorIons(pest_dda, pch = 16, col = "#377EB8") +
  ggtitle("Filled Circles (pch = 16)")

# Filled circles with border (pch = 21)
p3 <- gplotPrecursorIons(pest_dda, pch = 21, col = "black", bg = "#4DAF4A80") +
  ggtitle("Filled with Border (pch = 21)")

p1
p2
p3
```

## Adding ggplot2 Layers

Since the output is a ggplot object, we can add additional layers:

```{r ggplot_enhancements}
gplotPrecursorIons(pest_dda) +
  ggtitle("DDA Precursor Ion Map") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title = element_text(size = 12),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank()
  ) +
  annotate("text", x = 200, y = 500,
           label = "High m/z region",
           hjust = 0, color = "darkred")
```

# Interactive Visualization

## Basic Interactive Plot

```{r interactive}
p_interactive <- gplotPrecursorIons(pest_dda)
ggplotly(p_interactive)
```

The interactive plot allows you to:
- Hover over points to see exact RT and m/z values
- Zoom into specific regions
- Pan across the plot
- Download the plot as an image

## Enhanced Interactive Plot

```{r interactive_enhanced}
p_enhanced <- gplotPrecursorIons(
  pest_dda,
  xlab = "Retention Time (s)",
  ylab = "Precursor m/z"
) +
  theme_minimal() +
  ggtitle("Interactive Precursor Ion Visualization")

ggplotly(p_enhanced) %>%
  layout(
    hovermode = "closest",
    showlegend = FALSE
  )
```

# Multiple Files

If your MsExperiment contains multiple files, `gplotPrecursorIons()` returns a list of plots:

```{r multiple_files}
#| eval: false
# Example with multiple files (not run - requires multiple DDA files)
files <- c("file1.mzML", "file2.mzML", "file3.mzML")
multi_dda <- readMsExperiment(files)

# Returns list of plots
plots <- gplotPrecursorIons(multi_dda)

# Access individual plots
plots[[1]]
plots[[2]]
plots[[3]]
```

# Assessing DDA Performance

## Coverage Assessment

```{r coverage}
# Add horizontal lines to show m/z ranges
gplotPrecursorIons(pest_dda) +
  geom_hline(yintercept = c(100, 200, 300, 400, 500),
             linetype = "dashed", alpha = 0.3) +
  annotate("text", x = max(rtime(spectra(pest_dda))) * 0.98,
           y = c(100, 200, 300, 400, 500),
           label = paste0(c(100, 200, 300, 400, 500), " m/z"),
           hjust = 1, vjust = -0.5, size = 3, color = "gray40")
```

## Temporal Distribution

```{r temporal}
# Add vertical lines to divide chromatogram into regions
rt_range <- range(rtime(spectra(pest_dda)))
divisions <- seq(rt_range[1], rt_range[2], length.out = 6)

gplotPrecursorIons(pest_dda) +
  geom_vline(xintercept = divisions[-c(1, 6)],
             linetype = "dotted", alpha = 0.5, color = "blue") +
  theme_minimal()
```

# Comparison with Original XCMS

<div class="row">
<div class="col-md-6">

## Original XCMS Version

```{r original_comparison}
#| fig-height: 6
#| fig-width: 5
#| fig-alt: "XCMS plotPrecursorIons showing precursor ions in MS/MS data using base R graphics."
# XCMS original (base R graphics)
xcms::plotPrecursorIons(pest_dda)
```

</div>
<div class="col-md-6">

## xcmsVis ggplot2 Version

```{r xcmsvis_comparison}
#| fig-height: 6
#| fig-width: 5
#| fig-alt: "ggplot2 version of plotPrecursorIons showing precursor ions with clean styling and consistent API."
# xcmsVis version (ggplot2)
gplotPrecursorIons(pest_dda)
```

</div>
</div>

**Key advantages of ggplot2 version:**
- Can be easily customized with ggplot2 syntax
- Seamlessly converts to interactive plots with plotly
- Better integration with modern R visualization workflows
- Consistent styling with other xcmsVis functions
- Better handling of plot annotations and layering

# Use Cases

## 1. Method Development

Visualize how changes in DDA parameters affect precursor selection:

```{r method_dev}
#| eval: false
# Compare different DDA methods
method1_data <- readMsExperiment("method1.mzML")
method2_data <- readMsExperiment("method2.mzML")

p1 <- gplotPrecursorIons(method1_data) + ggtitle("Method 1: TopN = 10")
p2 <- gplotPrecursorIons(method2_data) + ggtitle("Method 2: TopN = 20")

library(patchwork)
p1 / p2
```

## 2. Quality Control

Check for expected MS/MS coverage:

```{r qc}
gplotPrecursorIons(pest_dda) +
  ggtitle("QC: Precursor Ion Coverage Check") +
  theme_minimal() +
  labs(caption = paste("Total MS/MS scans:",
                       sum(!is.na(precursorMz(spectra(pest_dda))))))
```

## 3. Targeted vs. Untargeted Analysis

Overlay expected compound m/z values to verify fragmentation:

```{r targeted}
#| eval: false
# Example target list
targets <- data.frame(
  compound = c("Compound A", "Compound B", "Compound C"),
  mz = c(245.123, 389.456, 512.789)
)

gplotPrecursorIons(pest_dda) +
  geom_hline(data = targets, aes(yintercept = mz),
             color = "red", linetype = "dashed", alpha = 0.7) +
  geom_text(data = targets, aes(x = 50, y = mz, label = compound),
            hjust = 0, vjust = -0.5, color = "red", size = 3)
```

# Summary

The `gplotPrecursorIons()` function provides:
- Visual assessment of MS/MS experiment quality
- Easy identification of fragmentation patterns
- Publication-ready figures with ggplot2 customization
- Interactive exploration with plotly integration
- Tools for method development and optimization

# Session Info

```{r session_info}
sessionInfo()
```
