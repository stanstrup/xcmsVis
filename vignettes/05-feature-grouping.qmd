---
title: "Step 5: Feature Grouping Visualization"
author: "xcmsVis Package"
date: today
format:
  html:
    toc: true
    toc-location: left
    code-fold: false
    theme: cosmo
vignette: >
  %\VignetteIndexEntry{Step 5: Feature Grouping Visualization}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

```{r setup}
#| include: false
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 10,
  fig.height = 6,
  warning = FALSE,
  message = FALSE
)
```

# Introduction

This vignette covers the **final step** in the XCMS metabolomics workflow: **feature grouping**. After retention time alignment, these functions help you:

- Visualize relationships between features
- Identify isotopes, adducts, and fragments
- Assess feature annotation quality
- Create publication-ready feature network plots

## XCMS Workflow Context

```
┌─────────────────────────────────────┐
│ 1. Raw Data Visualization           │
│ 2. Peak Detection                   │
│ 3. Peak Correspondence               │
│ 4. Retention Time Alignment          │
├─────────────────────────────────────┤
│ 5. FEATURE GROUPING      ← YOU ARE HERE
└─────────────────────────────────────┘
```

## What is Feature Grouping?

Feature grouping identifies features that likely represent the same compound. After feature detection and correspondence, `groupFeatures()` connects features that may be:

- **Isotopes**: M+1, M+2 isotopic peaks
- **Adducts**: [M+H]+, [M+Na]+, [M+K]+, etc.
- **Fragments**: In-source fragmentation products
- **Correlated features**: Compounds with similar abundance patterns

The `gplotFeatureGroups()` function visualizes these relationships by plotting features connected by lines within each group across retention time and m/z dimensions.

## Functions Covered

- **`gplotFeatureGroups()`**: Visualize feature group relationships in RT/m/z space

# Setup

```{r libraries}
library(xcms)
library(xcmsVis)
library(MsExperiment)
library(MsFeatures)
library(ggplot2)
library(BiocParallel)
library(patchwork)

# Configure for serial processing
register(SerialParam())
```

# Load and Process Data

Feature grouping requires a complete XCMS workflow: peak detection, correspondence, retention time alignment, re-correspondence, and then feature grouping.

```{r load_data}
# Load example data
cdf_files <- dir(system.file("cdf", package = "faahKO"),
                 recursive = TRUE, full.names = TRUE)[1:3]

# Create XcmsExperiment
xdata <- readMsExperiment(spectraFiles = cdf_files)

# Add sample metadata
sampleData(xdata)$sample_name <- basename(cdf_files)
sampleData(xdata)$sample_group <- c("KO", "KO", "WT")

cat("Loaded", length(fileNames(xdata)), "files\n")
```

## Complete XCMS Workflow

```{r workflow}
# 1. Peak detection
cwp <- CentWaveParam(peakwidth = c(20, 80), ppm = 25, noise = 1000)
xdata <- findChromPeaks(xdata, param = cwp)
cat("Detected", nrow(chromPeaks(xdata)), "peaks\n")

# 2. Peak grouping (correspondence)
pdp <- PeakDensityParam(sampleGroups = sampleData(xdata)$sample_group,
                        minFraction = 0.5, bw = 30)
xdata <- groupChromPeaks(xdata, param = pdp)
cat("Grouped into", nrow(featureDefinitions(xdata)), "features\n")

# 3. Retention time alignment
xdata <- adjustRtime(xdata, param = ObiwarpParam())

# 4. Re-group after alignment
xdata <- groupChromPeaks(xdata, param = pdp)
cat("After alignment:", nrow(featureDefinitions(xdata)), "features\n")

# 5. Group features (identify related features)
xdata <- groupFeatures(xdata, param = SimilarRtimeParam(diffRt = 20))
cat("Identified", length(unique(featureGroups(xdata))), "feature groups\n")
```

# Basic Feature Group Visualization

The default plot shows all feature groups, with features connected by lines within each group:

```{r basic_plot}
#| fig-height: 6
#| fig-width: 10
gplotFeatureGroups(xdata)
```

## Interpretation

- **Points**: Individual features (at their median RT and m/z across samples)
- **Lines**: Connect features within the same group
- **Groups**: Represent features likely from the same compound (isotopes, adducts, etc.)

# Filtering to Specific Feature Groups

You can visualize specific feature groups of interest:

```{r specific_groups}
#| fig-height: 6
#| fig-width: 10
# Get all feature group IDs
all_groups <- unique(featureGroups(xdata))
cat("Feature groups:", head(all_groups, 10), "\n")

# Plot first 5 groups
gplotFeatureGroups(xdata, featureGroups = all_groups[1:5]) +
  ggtitle("First 5 Feature Groups")
```

# Customization

## Custom Styling

```{r custom_style}
#| fig-height: 6
#| fig-width: 10
# Get first 5 feature groups for clearer visualization
all_groups <- unique(featureGroups(xdata))

gplotFeatureGroups(xdata,
                   featureGroups = all_groups[1:5],
                   col = "#E31A1C",  # Red color
                   pch = 16,          # Solid circles
                   xlab = "Retention Time (sec)",
                   ylab = "Mass-to-Charge Ratio (m/z)",
                   main = "Custom Styled Feature Groups")
```

## Different Plot Types

The `type` parameter controls whether to show lines, points, or both:

```{r plot_types}
#| fig-height: 12
#| fig-width: 10
# Use subset of feature groups for clearer visualization
fg_subset <- all_groups[1:5]

# Plot with lines and points (default)
p1 <- gplotFeatureGroups(xdata, featureGroups = fg_subset, type = "o") +
  ggtitle('type = "o" (overplot - lines + points)')

# Plot with lines only
p2 <- gplotFeatureGroups(xdata, featureGroups = fg_subset, type = "l") +
  ggtitle('type = "l" (lines only)')

# Plot with points only
p3 <- gplotFeatureGroups(xdata, featureGroups = fg_subset, type = "p", pch = 16) +
  ggtitle('type = "p" (points only)')

# Combine plots
p1 / p2 / p3
```

## Zooming to Specific Regions

Use `xlim` and `ylim` to focus on specific retention time or m/z ranges:

```{r zoom}
#| fig-height: 6
#| fig-width: 10
# Focus on features between 3200-3300 seconds RT and specific feature groups
gplotFeatureGroups(xdata,
                   featureGroups = fg_subset,
                   xlim = c(3200, 3300),
                   ylim = c(200, 600)) +
  ggtitle("Features in RT 3200-3300 sec, m/z 200-600")
```

# Interactive Visualization

Convert to interactive plotly plot for exploration:

```{r interactive}
#| fig-height: 6
#| fig-width: 10
library(plotly)

# Use subset for better interactivity
p <- gplotFeatureGroups(xdata, featureGroups = fg_subset)
ggplotly(p)
```

# Understanding Feature Groups

Feature groups represent features that are likely derived from the same compound. Common grouping parameters:

## Similar Retention Time

```{r similar_rt}
# Group features with similar retention times (likely isotopes/adducts)
xdata_rt <- groupFeatures(xdata, param = SimilarRtimeParam(diffRt = 10))
cat("SimilarRtimeParam (diffRt=10):",
    length(unique(featureGroups(xdata_rt))), "groups\n")

# Show first 5 groups
fg_rt <- unique(featureGroups(xdata_rt))
gplotFeatureGroups(xdata_rt, featureGroups = fg_rt[1:5]) +
  ggtitle("Feature Groups: Similar Retention Time (diffRt = 10 sec)")
```

## Abundance Correlation

```{r correlation}
# Group features with correlated abundances across samples
xdata_cor <- groupFeatures(xdata, param = AbundanceSimilarityParam(threshold = 0.7))
cat("AbundanceSimilarityParam (threshold=0.7):",
    length(unique(featureGroups(xdata_cor))), "groups\n")

# Show first 5 groups
fg_cor <- unique(featureGroups(xdata_cor))
gplotFeatureGroups(xdata_cor, featureGroups = fg_cor[1:5]) +
  ggtitle("Feature Groups: Abundance Correlation (threshold = 0.7)")
```

# Use Cases

## Isotope Pattern Identification

Features grouped by similar RT and m/z spacing may represent isotope patterns (M, M+1, M+2).

## Adduct Identification

Features with similar RT but different m/z values that correlate in abundance may be different adducts of the same compound.

## Quality Control

Visualize feature groups to:

- Verify grouping parameters are appropriate
- Identify over-grouping (too many features in one group)
- Identify under-grouping (features that should be grouped but aren't)

## Publication Figures

Create clean, customizable figures showing compound annotation:

```{r publication}
#| fig-height: 6
#| fig-width: 10
gplotFeatureGroups(xdata, featureGroups = fg_subset) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title = element_text(size = 12),
    panel.grid.major = element_line(color = "gray90")
  ) +
  labs(
    title = "Feature Group Relationships",
    caption = "Connected features represent potential isotopes, adducts, or fragments"
  )
```

# Summary

## Functions Covered

| Function | Purpose | Input |
|----------|---------|-------|
| `gplotFeatureGroups()` | Visualize feature group relationships | XcmsExperiment, XCMSnExp |

## Use Cases

- **Compound annotation**: Identify isotopes, adducts, and fragments
- **Quality control**: Verify feature grouping quality
- **Method development**: Optimize groupFeatures parameters
- **Publication**: Create network plots of feature relationships

## Workflow Complete!

You've now completed the full XCMS visualization workflow:

```
✓ 1. Raw Data Visualization
✓ 2. Peak Detection
✓ 3. Peak Correspondence
✓ 4. Retention Time Alignment
✓ 5. Feature Grouping
```

# Comparison with Original XCMS

<div class="row">
<div class="col-md-6">

## Original XCMS Version

```{r original_comparison}
#| fig-height: 6
#| fig-width: 5
#| fig-alt: "XCMS plotFeatureGroups using base R graphics."
# XCMS original (base R graphics)
plotFeatureGroups(xdata, featureGroups = c("FG.0001", "FG.0002", "FG.0003", "FG.0004", "FG.0005"))
```

</div>
<div class="col-md-6">

## xcmsVis ggplot2 Version

```{r xcmsvis_comparison}
#| fig-height: 6
#| fig-width: 5
#| fig-alt: "ggplot2 version with clean styling and consistent API."
# xcmsVis version (ggplot2)
gplotFeatureGroups(xdata, featureGroups = c("FG.0001", "FG.0002", "FG.0003", "FG.0004", "FG.0005"))
```

</div>
</div>

# Session Info

```{r session_info}
sessionInfo()
```
