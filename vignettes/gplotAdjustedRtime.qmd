---
title: "Visualizing Retention Time Adjustment with gplotAdjustedRtime"
author: "xcmsVis Package"
date: today
format:
  html:
    toc: true
    toc-location: left
    code-fold: false
    theme: cosmo
vignette: >
  %\VignetteIndexEntry{Visualizing Retention Time Adjustment with gplotAdjustedRtime}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

```{r setup}
#| include: false
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 6,
  warning = FALSE,
  message = FALSE
)
```

# Introduction

This vignette demonstrates the `gplotAdjustedRtime()` function, which provides a modern ggplot2-based visualization of retention time correction in LC-MS metabolomics data. The function is designed to work with both `XcmsExperiment` (XCMS v4+) and `XCMSnExp` (XCMS v3) objects.

# Setup

```{r libraries}
library(xcms)
library(xcmsVis)
library(ggplot2)
library(plotly)
library(faahKO)
library(MsExperiment)
```

# Data Preparation

We'll use the faahKO package, which contains example LC-MS data from an analysis of fatty acid amide hydrolase (FAAH) knockout mice.

```{r load_data}
# Get example CDF files from faahKO package (load once, reuse throughout)
cdf_files <- dir(system.file("cdf", package = "faahKO"),
                  recursive = TRUE, full.names = TRUE)

# Using 3 samples from each group (6 total)
cdf_files <- cdf_files[c(1:3, 7:9)]

# Load data as XcmsExperiment
xdata_raw <- readMsExperiment(spectraFiles = cdf_files)

# Add sample metadata
sample_group <- rep(c("KO", "WT"), each = 3)
sampleData(xdata_raw)$sample_name <- basename(cdf_files)
sampleData(xdata_raw)$sample_group <- sample_group
```


Data can also be of the old style "XCMSnExp" (not run) from MSnbase.
```{r coerce}
#| eval: false
xdata_raw <- as(as(xdata_raw, "XcmsExperiment"), "XCMSnExp")
```


## Peak Detection (performed once)

```{r peak_detection}
# Peak detection using CentWave algorithm (done once for efficiency)
cwp <- CentWaveParam(
  peakwidth = c(20, 80),
  ppm = 25
)
xdata_peaks <- findChromPeaks(xdata_raw, param = cwp)

# Create PeakDensityParam once (reused across all examples)
sample_data <- xcmsVis:::.get_sample_data(xdata_peaks)
pdp <- PeakDensityParam(
  sampleGroups = sample_data$sample_group,
  minFraction = 0.4,
  bw = 30
)
```

# Basic Usage

## Complete XCMS Workflow

The proper XCMS workflow for retention time adjustment using peak groups is:

1. Peak detection (already done above)
2. Initial correspondence (grouping)
3. Retention time adjustment
4. Re-do correspondence

```{r xcms_workflow}
# Work with a copy for the basic workflow
xdata <- xdata_peaks

# Initial correspondence (peak grouping) before alignment
xdata <- groupChromPeaks(xdata, param = pdp)

# Retention time alignment using peak groups
pgp <- PeakGroupsParam(
  minFraction = 0.4,
  smooth = "loess",
  span = 0.2,
  family = "gaussian"
)
xdata <- adjustRtime(xdata, param = pgp)

# Re-do correspondence after alignment
xdata <- groupChromPeaks(xdata, param = pdp)
```

## Creating the Plot

<div class="row">
<div class="col-md-6">

### Original XCMS Version

```{r original_plot}
#| fig-height: 4
#| fig-width: 5
#| fig-alt: "Retention time adjustment plot from XCMS showing RT deviation vs adjusted retention time. Six colored lines represent individual samples (3 KO and 3 WT), with grey circles indicating alignment peaks and dashed grey lines connecting corresponding features across samples."
# Base R graphics version
sample_data <- xcmsVis:::.get_sample_data(xdata)

plotAdjustedRtime(
  xdata,
  col = as.factor(sample_data$sample_group),
  peakGroupsCol = "grey"
)
```

</div>
<div class="col-md-6">

### xcmsVis ggplot2 Version

```{r ggplot_version}
#| fig-height: 4
#| fig-width: 5
#| fig-alt: "Modern ggplot2 version of retention time adjustment plot showing RT deviation vs adjusted retention time. Six colored lines distinguish KO and WT sample groups, with grey circles marking alignment peaks and dashed grey lines connecting corresponding features."
# ggplot2 version
p <- gplotAdjustedRtime(xdata, color_by = sample_group)
print(p)
```

</div>
</div>

The plot shows:
- **Lines**: One per sample, showing RT deviation across the chromatographic run
- **Grey circles**: Individual peaks used for alignment
- **Grey dashed lines**: Connect peaks from the same feature across samples

## Customizing the Plot

Since `gplotAdjustedRtime()` returns a ggplot object, you can easily customize it:

```{r customized_plot}
#| fig-height: 5
#| fig-width: 7
#| fig-alt: "Customized retention time adjustment plot with minimal theme and Set1 color palette. Plot titled 'Retention Time Correction - faahKO Dataset' shows RT adjustment in seconds vs adjusted retention time, with KO and WT groups color-coded and legend positioned at top."
p +
  labs(
    title = "Retention Time Correction - faahKO Dataset",
    x = "Adjusted Retention Time (s)",
    y = "RT Adjustment (s)",
    color = "Sample Group"
  ) +
  theme_minimal() +
  scale_color_brewer(palette = "Set1") +
  theme(legend.position = "top")
```

## Interactive Visualization

Convert to an interactive plotly plot:

```{r interactive}
#| fig-alt: "Interactive plotly version of the retention time adjustment plot. Hovering over data points reveals detailed sample information including file name, sample group, and exact RT values. Users can zoom, pan, and interact with the visualization."
# Make it interactive
p_interactive <- ggplotly(p, tooltip = "text")
p_interactive
```

# Advanced Use Cases

## With filterFile()

Sometimes you may want to filter samples before alignment:

```{r with_filter}
# Work with a fresh copy from peak-detected data
xdata_filtered <- xdata_peaks

# Filter to specific samples (files 2-5)
xdata_filtered <- filterFile(xdata_filtered, c(2:5))

# Group peaks after filtering (reuse pdp from above)
xdata_filtered <- groupChromPeaks(xdata_filtered, param = pdp)

# Align filtered data
pgp_filter <- PeakGroupsParam(minFraction = 0.4)
xdata_filtered <- adjustRtime(xdata_filtered, param = pgp_filter)
xdata_filtered <- groupChromPeaks(xdata_filtered, param = pdp)
```

<div class="row">
<div class="col-md-6">

### Original XCMS

```{r original_filtered}
#| fig-height: 4
#| fig-width: 5
#| fig-alt: "XCMS retention time adjustment plot for filtered dataset (files 2-5 only). Four colored lines show RT deviation patterns for the subset of samples, with grey alignment peaks and feature connections."
sample_data <- xcmsVis:::.get_sample_data(xdata_filtered)

plotAdjustedRtime(
  xdata_filtered,
  col = as.factor(sample_data$sample_group),
  peakGroupsCol = "grey"
)
```

</div>
<div class="col-md-6">

### xcmsVis Version

```{r ggplot_filtered}
#| fig-height: 4
#| fig-width: 5
#| fig-alt: "ggplot2 retention time adjustment plot for filtered dataset. Four lines display RT corrections for samples 2-5, color-coded by KO/WT group, with grey alignment peaks and feature connections."
p_filtered <- gplotAdjustedRtime(xdata_filtered, color_by = sample_group)
print(p_filtered)
```

</div>
</div>

## With subset Parameter in PeakGroupsParam

You can use only specific samples for alignment calculation while keeping all samples in the dataset:

```{r with_subset}
# Work with a fresh copy
xdata_subset <- xdata_peaks

# Group peaks (reuse pdp from above)
xdata_subset <- groupChromPeaks(xdata_subset, param = pdp)

# Use subset parameter to align using only specific samples
pgp_subset <- PeakGroupsParam(
  minFraction = 0.4,
  smooth = "loess",
  span = 0.2,
  family = "gaussian",
  subset = c(1, 2, 3, 5)  # Exclude sample 4 from alignment calculation
)
xdata_subset <- adjustRtime(xdata_subset, param = pgp_subset)
xdata_subset <- groupChromPeaks(xdata_subset, param = pdp)
```

<div class="row">
<div class="col-md-6">

### Original XCMS

```{r original_subset}
#| fig-height: 4
#| fig-width: 5
#| fig-alt: "XCMS retention time adjustment plot using subset parameter. All six samples are shown, but alignment was calculated using only samples 1, 2, 3, and 5, excluding sample 4. Grey alignment peaks and feature connections indicate which peaks were used."
sample_data <- xcmsVis:::.get_sample_data(xdata_subset)

plotAdjustedRtime(
  xdata_subset,
  col = as.factor(sample_data$sample_group),
  peakGroupsCol = "grey"
)
```

</div>
<div class="col-md-6">

### xcmsVis Version

```{r ggplot_subset}
#| fig-height: 4
#| fig-width: 5
#| fig-alt: "ggplot2 retention time adjustment plot with subset alignment. Six colored lines represent all samples (KO and WT groups), but RT correction was calculated using only a subset (samples 1, 2, 3, 5). Grey points show alignment peaks used."
p_subset <- gplotAdjustedRtime(xdata_subset, color_by = sample_group)
print(p_subset)
```

</div>
</div>

## Without subset Parameter (All Samples)

For comparison, here's alignment using all samples:

```{r without_subset}
# Work with a fresh copy
xdata_no_subset <- xdata_peaks

# Group peaks (reuse pdp from above)
xdata_no_subset <- groupChromPeaks(xdata_no_subset, param = pdp)

# Align without subset parameter (use all samples)
pgp_no_subset <- PeakGroupsParam(minFraction = 0.4)
xdata_no_subset <- adjustRtime(xdata_no_subset, param = pgp_no_subset)
xdata_no_subset <- groupChromPeaks(xdata_no_subset, param = pdp)
```

<div class="row">
<div class="col-md-6">

### Original XCMS

```{r original_no_subset}
#| fig-height: 4
#| fig-width: 5
#| fig-alt: "XCMS retention time adjustment plot without subset parameter, using all six samples for alignment calculation. Colored lines show RT deviation for each sample, with grey circles and dashed lines marking alignment peaks and feature correspondences."
sample_data <- xcmsVis:::.get_sample_data(xdata_no_subset)

plotAdjustedRtime(
  xdata_no_subset,
  col = as.factor(sample_data$sample_group),
  peakGroupsCol = "grey"
)
```

</div>
<div class="col-md-6">

### xcmsVis Version

```{r ggplot_no_subset}
#| fig-height: 4
#| fig-width: 5
#| fig-alt: "ggplot2 retention time adjustment plot with all samples used for alignment. Six lines color-coded by sample group (KO and WT) display RT corrections, with grey alignment peaks and feature connections showing comprehensive alignment across all samples."
p_no_subset <- gplotAdjustedRtime(xdata_no_subset, color_by = sample_group)
print(p_no_subset)
```

</div>
</div>

# Advantages of gplotAdjustedRtime

**Compared to XCMS's `plotAdjustedRtime()`:**

- Modern ggplot2 aesthetics
- Easy customization using standard ggplot2 syntax
- Interactive plotting via plotly
- Automatic legend generation
- Consistent with other ggplot2-based visualizations
- Publication-ready output

# Session Information

```{r session_info}
sessionInfo()
```

# References

- XCMS GitHub Repository: https://github.com/sneumann/xcms
- Original Feature Request: https://github.com/sneumann/xcms/issues/551
- faahKO package: Bioconductor example dataset
- ggplot2 Documentation: https://ggplot2.tidyverse.org/
- plotly for R: https://plotly.com/r/
