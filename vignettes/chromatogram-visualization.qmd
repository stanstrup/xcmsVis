---
title: "Visualizing Chromatograms and Peak Density"
author: "xcmsVis Package"
date: today
format:
  html:
    toc: true
    toc-location: left
    code-fold: false
    theme: cosmo
vignette: >
  %\VignetteIndexEntry{Visualizing Chromatograms and Peak Density}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

```{r setup}
#| include: false
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 6,
  warning = FALSE,
  message = FALSE
)
```

# Introduction

This vignette demonstrates ggplot2-based functions for visualizing chromatograms and evaluating peak density correspondence:

- **`gplot()`**: Plot individual chromatograms with detected peaks
- **`gplotChromPeakDensity()`**: Visualize peak density for optimizing correspondence parameters
- **`gplotChromatogramsOverlay()`**: Create overlay plots of multiple extracted ion chromatograms (EICs)

These functions work with `XChromatograms` and `MChromatograms` objects from the XCMS package.

# Setup

```{r libraries}
library(xcms)
library(ggplot2)
library(plotly)
library(patchwork)
library(xcmsVis)
```

# Data Preparation

We'll use pre-processed test data from XCMS for faster execution:

```{r load_data}
# Load pre-processed data with detected peaks
xdata <- loadXcmsData("faahko_sub2")

# Check data
cat("Samples:", length(fileNames(xdata)), "\n")
cat("Total peaks detected:", nrow(chromPeaks(xdata)), "\n")
```

# gplot: Individual Chromatogram Visualization

The `gplot()` function creates chromatogram plots with detected peaks automatically annotated.

## Basic Usage

::: {style="display: flex; gap: 2em;"}
::: {style="flex: 1;"}

### Original XCMS Version

```{r original_gplot}
#| fig-height: 4
#| fig-width: 5
#| fig-alt: "XCMS plot showing a single chromatogram with detected peaks marked as polygons. The x-axis shows retention time and y-axis shows intensity."
# Extract chromatogram for one sample
chr <- chromatogram(xdata, mz = c(305.05, 305.15))

# Base R graphics version
plot(chr[1, 1])
```

:::

::: {style="flex: 1;"}

### xcmsVis ggplot2 Version

```{r xcmsvis_gplot}
#| fig-height: 4
#| fig-width: 5
#| fig-alt: "ggplot2 version of the same chromatogram showing retention time vs intensity with peaks marked as shaded polygons. The plot uses a clean theme with proper axis labels."
# ggplot2 version
gplot(chr[1, 1])
```

:::
:::

## Multiple Peak Types

```{r peak_types}
#| fig-height: 8
#| fig-width: 8
#| fig-alt: "Four panel plot showing the same chromatogram with different peak annotation styles: polygon (shaded area), point (apex markers), rectangle (bounding boxes), and none (no annotations)."
p1 <- gplot(chr[1, 1], peakType = "polygon") + ggtitle("Polygon")
p2 <- gplot(chr[1, 1], peakType = "point") + ggtitle("Point")
p3 <- gplot(chr[1, 1], peakType = "rectangle") + ggtitle("Rectangle")
p4 <- gplot(chr[1, 1], peakType = "none") + ggtitle("None")

(p1 | p2) / (p3 | p4)
```

## Interactive with plotly

```{r interactive_gplot}
#| fig-height: 4
#| fig-width: 8
#| fig-alt: "Interactive plotly chromatogram allowing zoom, pan, and hover to inspect peak details."
ggplotly(gplot(chr[1, 1]))
```

# gplotChromPeakDensity: Peak Density Visualization

The `gplotChromPeakDensity()` function helps optimize peak density correspondence parameters by visualizing how peaks would be grouped.

## Basic Usage

::: {style="display: flex; gap: 2em;"}
::: {style="flex: 1;"}

### Original XCMS Version

```{r original_peakdensity}
#| fig-height: 6
#| fig-width: 5
#| fig-alt: "XCMS plotChromPeakDensity showing a two-panel figure. Upper panel displays overlaid chromatograms from multiple samples. Lower panel shows peak positions as points with a density curve overlay and grey rectangles indicating how peaks would be grouped into features."
# Base R graphics version
prm <- PeakDensityParam(sampleGroups = rep(1, 3), bw = 30)
plotChromPeakDensity(chr, param = prm)
```

:::

::: {style="flex: 1;"}

### xcmsVis ggplot2 Version

```{r xcmsvis_peakdensity}
#| fig-height: 6
#| fig-width: 5
#| fig-alt: "ggplot2 version of peak density plot with the same two-panel layout. Uses patchwork for clean panel stacking and ggplot2 aesthetics for better readability."
# ggplot2 version
gplotChromPeakDensity(chr, param = prm)
```

:::
:::

## Optimizing Bandwidth Parameter

The bandwidth (`bw`) parameter controls the smoothing of the density estimate. Larger values group more distant peaks together:

```{r bandwidth_comparison}
#| fig-height: 8
#| fig-width: 10
#| fig-alt: "Three side-by-side peak density plots showing the effect of different bandwidth values (bw = 15, 30, 60). Lower bandwidth separates peaks into more groups, while higher bandwidth merges nearby peaks."
prm_small <- PeakDensityParam(sampleGroups = rep(1, 3), bw = 15)
prm_medium <- PeakDensityParam(sampleGroups = rep(1, 3), bw = 30)
prm_large <- PeakDensityParam(sampleGroups = rep(1, 3), bw = 60)

p1 <- gplotChromPeakDensity(chr, param = prm_small) +
  ggtitle("Bandwidth = 15")
p2 <- gplotChromPeakDensity(chr, param = prm_medium) +
  ggtitle("Bandwidth = 30")
p3 <- gplotChromPeakDensity(chr, param = prm_large) +
  ggtitle("Bandwidth = 60")

p1 | p2 | p3
```

## Showing Actual Correspondence Results

After running correspondence analysis, you can visualize the actual feature grouping by setting `simulate = FALSE`:

```{r actual_correspondence}
#| fig-height: 6
#| fig-width: 8
#| fig-alt: "Peak density plot showing actual feature grouping after correspondence analysis. Vertical dashed lines indicate the median retention time for each feature."
# Perform correspondence
xdata_grouped <- groupChromPeaks(xdata, param = PeakDensityParam(
  sampleGroups = rep(1, 3),
  minFraction = 0.4,
  bw = 30
))

# Extract chromatogram again (now with correspondence info)
chr_grouped <- chromatogram(xdata_grouped, mz = c(305.05, 305.15))

# Plot with actual grouping
gplotChromPeakDensity(chr_grouped, simulate = FALSE) +
  ggtitle("Actual Correspondence Results")
```

# gplotChromatogramsOverlay: Overlay Visualization

The `gplotChromatogramsOverlay()` function overlays **different EICs (rows)** from the **same sample (column)** in one plot. This is different from `gplot()` which overlays the **same EIC** across **different samples**.

## Understanding the Difference

::: {.callout-important}
## Key Concept

- **`gplot()`**: Overlays the SAME m/z range across DIFFERENT samples
- **`gplotChromatogramsOverlay()`**: Overlays DIFFERENT m/z ranges within the SAME sample
:::

## Single Sample: Multiple EICs Overlaid

::: {style="display: flex; gap: 2em;"}
::: {style="flex: 1;"}

### Original XCMS Version

```{r original_overlay_single}
#| fig-height: 5
#| fig-width: 5
#| fig-alt: "XCMS plotChromatogramsOverlay showing two different EICs (m/z 305 and m/z 344) overlaid in a single plot from one sample."
# Extract multiple EICs from ONE sample
chr_multi <- chromatogram(xdata[1,], mz = rbind(
  c(305.05, 305.15),
  c(344.0, 344.2)
))

# Base R graphics version
plotChromatogramsOverlay(chr_multi, main = "Sample 1")
```

:::

::: {style="flex: 1;"}

### xcmsVis ggplot2 Version

```{r xcmsvis_overlay_single}
#| fig-height: 5
#| fig-width: 5
#| fig-alt: "ggplot2 version showing the same two EICs overlaid with cleaner aesthetics and proper legend handling."
# ggplot2 version
gplotChromatogramsOverlay(chr_multi, main = "Sample 1")
```

:::
:::

## Multiple Samples: Faceted Layout

When you have multiple samples, `gplotChromatogramsOverlay()` creates a faceted plot with one panel per sample:

::: {style="display: flex; gap: 2em;"}
::: {style="flex: 1;"}

### Original XCMS Version

```{r original_overlay_multi}
#| fig-height: 7
#| fig-width: 5
#| fig-alt: "XCMS plotChromatogramsOverlay with three vertically stacked panels, one for each sample. Each panel shows two EICs overlaid."
# Extract multiple EICs from ALL samples
chr_all <- chromatogram(xdata, mz = rbind(
  c(305.05, 305.15),
  c(344.0, 344.2)
))

# Base R graphics version - creates multi-panel plot
plotChromatogramsOverlay(chr_all,
                         main = c("Sample 1", "Sample 2", "Sample 3"))
```

:::

::: {style="flex: 1;"}

### xcmsVis ggplot2 Version

```{r xcmsvis_overlay_multi}
#| fig-height: 7
#| fig-width: 5
#| fig-alt: "ggplot2 version using facet_wrap to create three panels, one per sample, with overlaid EICs in each."
# ggplot2 version - uses faceting
gplotChromatogramsOverlay(chr_all,
                          main = c("Sample 1", "Sample 2", "Sample 3"))
```

:::
:::

## Contrast: gplot() vs gplotChromatogramsOverlay()

Here's a direct comparison showing the key difference:

```{r comparison_plot_vs_overlay}
#| fig-height: 5
#| fig-width: 10
#| fig-alt: "Side-by-side comparison. Left: gplot shows one EIC across three samples overlaid. Right: gplotChromatogramsOverlay shows two EICs from one sample overlaid."
# LEFT: gplot() - same EIC (m/z 305) across different samples
chr_one_eic <- chromatogram(xdata, mz = c(305.05, 305.15))
p_left <- gplot(chr_one_eic) +
  ggtitle("gplot(): Same EIC, Different Samples")

# RIGHT: gplotChromatogramsOverlay() - different EICs within one sample
chr_multi_eic <- chromatogram(xdata[1,], mz = rbind(
  c(305.05, 305.15),
  c(344.0, 344.2)
))
p_right <- gplotChromatogramsOverlay(chr_multi_eic) +
  ggtitle("gplotChromatogramsOverlay(): Different EICs, Same Sample")

p_left | p_right
```

## Stacked Visualization

For better visual separation, chromatograms can be vertically offset:

::: {style="display: flex; gap: 2em;"}
::: {style="flex: 1;"}

### Original XCMS Version

```{r original_stacked}
#| fig-height: 5
#| fig-width: 5
#| fig-alt: "XCMS stacked overlay with chromatograms vertically offset by a fixed amount."
# Base R version
plotChromatogramsOverlay(chr_multi, stacked = 1e6, main = "Sample 1")
```

:::

::: {style="flex: 1;"}

### xcmsVis ggplot2 Version

```{r xcmsvis_stacked}
#| fig-height: 5
#| fig-width: 5
#| fig-alt: "ggplot2 stacked overlay preventing overlapping traces and making it easier to follow individual EICs."
# ggplot2 version
gplotChromatogramsOverlay(chr_multi, stacked = 1e6, main = "Sample 1")
```

:::
:::

## Intensity Transformation

Apply transformations for better visualization of low-intensity features:

```{r transformed_overlay}
#| fig-height: 5
#| fig-width: 8
#| fig-alt: "Overlay plot with log-transformed intensities, making low-intensity peaks more visible while compressing the dynamic range of high-intensity peaks."
gplotChromatogramsOverlay(chr_multi, transform = log1p, main = "Sample 1") +
  ggtitle("Log-Transformed Intensities")
```

## Custom Colors and Peak Styles

```{r custom_styling}
#| fig-height: 5
#| fig-width: 8
#| fig-alt: "Overlay plot with custom colors for lines (blue) and peaks (red), demonstrating the flexibility of styling options."
gplotChromatogramsOverlay(
  chr_multi,
  col = "blue",
  peakCol = "red",
  peakBg = "#ff000020",
  peakType = "rectangle",
  main = "Sample 1"
) + ggtitle("Custom Styling")
```

# Complete Workflow Example

Here's a complete workflow demonstrating how these functions work together:

```{r complete_workflow}
#| fig-height: 12
#| fig-width: 10
#| fig-alt: "Three-panel figure showing a complete XCMS workflow. Top panel: peak density visualization for parameter optimization. Middle panel: overlay of multiple EICs from one sample. Bottom panel: individual chromatogram with detected peaks marked."
# 1. Extract chromatogram for one m/z
chr_workflow <- chromatogram(xdata, mz = c(344.0, 344.2))

# 2. Check peak density with different parameters
prm1 <- PeakDensityParam(sampleGroups = rep(1, 3), bw = 20)
prm2 <- PeakDensityParam(sampleGroups = rep(1, 3), bw = 40)

p1 <- gplotChromPeakDensity(chr_workflow, param = prm1) +
  ggtitle("Peak Density (bw=20)")

p2 <- gplotChromPeakDensity(chr_workflow, param = prm2) +
  ggtitle("Peak Density (bw=40)")

# 3. Overlay multiple EICs from one sample
chr_overlay <- chromatogram(xdata[1,], mz = rbind(
  c(305.05, 305.15),
  c(344.0, 344.2)
))
p3 <- gplotChromatogramsOverlay(chr_overlay, main = "Sample 1") +
  ggtitle("Multiple EICs Overlaid")

# 4. Individual chromatogram detail
p4 <- gplot(chr_workflow[1, 1]) +
  ggtitle("Sample 1 Detail (m/z 344)")

# Combine all plots
(p1 | p2) / p3 / p4
```

# Interactive Exploration

All ggplot2 outputs can be converted to interactive plotly visualizations:

```{r interactive_complete}
#| fig-height: 6
#| fig-width: 10
#| fig-alt: "Interactive peak density plot with hover tooltips, zoom capabilities, and pan functionality for detailed exploration of peak grouping."
# Create interactive peak density plot
p <- gplotChromPeakDensity(chr, param = prm)
ggplotly(p)
```

# Summary

The chromatogram visualization functions in xcmsVis provide:

- **Consistent API**: All functions return ggplot objects that can be customized
- **Interactive capability**: Easy conversion to plotly for data exploration
- **Composition**: Use patchwork to combine multiple plots
- **Flexibility**: Extensive customization options for colors, styles, and transformations
- **Quality**: Publication-ready graphics with clean, modern aesthetics

## Key Differences Between Functions

| Function | Purpose | What it Overlays |
|----------|---------|------------------|
| `gplot()` | Compare same EIC across samples | SAME m/z, DIFFERENT samples |
| `gplotChromatogramsOverlay()` | Compare different EICs within sample | DIFFERENT m/z, SAME sample |
| `gplotChromPeakDensity()` | Optimize correspondence parameters | Density of peaks across samples |

These functions are particularly useful for:

1. **Parameter optimization**: `gplotChromPeakDensity()` helps tune correspondence parameters
2. **Quality control**: `gplotChromatogramsOverlay()` reveals co-eluting compounds within samples
3. **Sample comparison**: `gplot()` shows retention time shifts and intensity variations between samples
4. **Presentation**: All functions produce publication-quality figures
5. **Exploration**: Interactive plotly conversion enables detailed data inspection

# Session Info

```{r session_info}
sessionInfo()
```
