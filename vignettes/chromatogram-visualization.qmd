---
title: "Visualizing Chromatograms and Peak Density"
author: "xcmsVis Package"
date: today
format:
  html:
    toc: true
    toc-location: left
    code-fold: false
    theme: cosmo
vignette: >
  %\VignetteIndexEntry{Visualizing Chromatograms and Peak Density}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

```{r setup}
#| include: false
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 6,
  warning = FALSE,
  message = FALSE
)
```

# Introduction

This vignette demonstrates ggplot2-based functions for visualizing chromatograms and evaluating peak density correspondence:

- **`gplot()`**: Plot individual chromatograms with detected peaks
- **`gplotChromPeakDensity()`**: Visualize peak density for optimizing correspondence parameters
- **`gplotChromatogramsOverlay()`**: Create overlay plots of multiple chromatograms

These functions work with `XChromatograms` and `MChromatograms` objects from the XCMS package.

# Setup

```{r libraries}
library(xcms)
library(ggplot2)
library(plotly)
library(faahKO)
library(MsExperiment)
library(BiocParallel)
library(xcmsVis)
```

# Data Preparation

We'll use the faahKO package example data:

```{r load_data}
# Get example CDF files
cdf_files <- dir(system.file("cdf", package = "faahKO"),
                  recursive = TRUE, full.names = TRUE)[1:3]

# Load data as XcmsExperiment
xdata <- readMsExperiment(
  spectraFiles = cdf_files,
  BPPARAM = SerialParam()
)

# Add sample metadata
sampleData(xdata)$sample_name <- basename(cdf_files)
sampleData(xdata)$sample_group <- c("KO", "KO", "WT")
```

## Peak Detection

```{r peak_detection}
# Detect peaks using CentWave algorithm
cwp <- CentWaveParam(
  peakwidth = c(20, 80),
  ppm = 25
)
xdata <- findChromPeaks(xdata, param = cwp, BPPARAM = SerialParam())

# Check number of peaks detected
cat("Total peaks detected:", nrow(chromPeaks(xdata)), "\n")
```

## Extract Chromatograms

```{r extract_chromatograms}
# Extract chromatogram for a specific m/z range
chr <- chromatogram(xdata, mz = c(305.05, 305.15))

cat("Chromatogram dimensions:", nrow(chr), "rows x", ncol(chr), "columns\n")
cat("Number of peaks:", sum(hasChromPeaks(chr)), "\n")
```

# gplot: Individual Chromatogram Visualization

The `gplot()` function creates chromatogram plots with detected peaks automatically annotated.

## Basic Usage

<div class="row">
<div class="col-md-6">

### Original XCMS Version

```{r original_gplot}
#| fig-height: 4
#| fig-width: 5
#| fig-alt: "XCMS plot showing a single chromatogram with detected peaks marked as polygons. The x-axis shows retention time and y-axis shows intensity."
# Base R graphics version
plot(chr[1, 1])
```

</div>
<div class="col-md-6">

### xcmsVis ggplot2 Version

```{r xcmsvis_gplot}
#| fig-height: 4
#| fig-width: 5
#| fig-alt: "ggplot2 version of the same chromatogram showing retention time vs intensity with peaks marked as shaded polygons. The plot uses a clean theme with proper axis labels."
# ggplot2 version
gplot(chr[1, 1])
```

</div>
</div>

## Multiple Peak Types

```{r peak_types}
#| fig-height: 8
#| fig-width: 8
#| fig-alt: "Four panel plot showing the same chromatogram with different peak annotation styles: polygon (shaded area), point (apex markers), rectangle (bounding boxes), and none (no annotations)."
library(patchwork)

p1 <- gplot(chr[1, 1], peakType = "polygon") + ggtitle("Polygon")
p2 <- gplot(chr[1, 1], peakType = "point") + ggtitle("Point")
p3 <- gplot(chr[1, 1], peakType = "rectangle") + ggtitle("Rectangle")
p4 <- gplot(chr[1, 1], peakType = "none") + ggtitle("None")

(p1 | p2) / (p3 | p4)
```

## Interactive with plotly

```{r interactive_gplot}
#| fig-height: 4
#| fig-width: 8
#| fig-alt: "Interactive plotly chromatogram allowing zoom, pan, and hover to inspect peak details."
ggplotly(gplot(chr[1, 1]))
```

# gplotChromPeakDensity: Peak Density Visualization

The `gplotChromPeakDensity()` function helps optimize peak density correspondence parameters by visualizing how peaks would be grouped.

## Basic Usage

<div class="row">
<div class="col-md-6">

### Original XCMS Version

```{r original_peakdensity}
#| fig-height: 6
#| fig-width: 5
#| fig-alt: "XCMS plotChromPeakDensity showing a two-panel figure. Upper panel displays overlaid chromatograms from multiple samples. Lower panel shows peak positions as points with a density curve overlay and grey rectangles indicating how peaks would be grouped into features."
# Base R graphics version
prm <- PeakDensityParam(sampleGroups = rep(1, 3), bw = 30)
plotChromPeakDensity(chr, param = prm)
```

</div>
<div class="col-md-6">

### xcmsVis ggplot2 Version

```{r xcmsvis_peakdensity}
#| fig-height: 6
#| fig-width: 5
#| fig-alt: "ggplot2 version of peak density plot with the same two-panel layout. Uses patchwork for clean panel stacking and ggplot2 aesthetics for better readability."
# ggplot2 version
gplotChromPeakDensity(chr, param = prm)
```

</div>
</div>

## Optimizing Bandwidth Parameter

The bandwidth (`bw`) parameter controls the smoothing of the density estimate. Larger values group more distant peaks together:

```{r bandwidth_comparison}
#| fig-height: 8
#| fig-width: 10
#| fig-alt: "Three side-by-side peak density plots showing the effect of different bandwidth values (bw = 15, 30, 60). Lower bandwidth separates peaks into more groups, while higher bandwidth merges nearby peaks."
prm_small <- PeakDensityParam(sampleGroups = rep(1, 3), bw = 15)
prm_medium <- PeakDensityParam(sampleGroups = rep(1, 3), bw = 30)
prm_large <- PeakDensityParam(sampleGroups = rep(1, 3), bw = 60)

p1 <- gplotChromPeakDensity(chr, param = prm_small) +
  ggtitle("Bandwidth = 15")
p2 <- gplotChromPeakDensity(chr, param = prm_medium) +
  ggtitle("Bandwidth = 30")
p3 <- gplotChromPeakDensity(chr, param = prm_large) +
  ggtitle("Bandwidth = 60")

p1 | p2 | p3
```

## Showing Actual Correspondence Results

After running correspondence analysis, you can visualize the actual feature grouping by setting `simulate = FALSE`:

```{r actual_correspondence}
#| fig-height: 6
#| fig-width: 8
#| fig-alt: "Peak density plot showing actual feature grouping after correspondence analysis. Vertical dashed lines indicate the median retention time for each feature."
# Perform correspondence
xdata <- groupChromPeaks(xdata, param = PeakDensityParam(
  sampleGroups = rep(1, 3),
  minFraction = 0.4,
  bw = 30
))

# Extract chromatogram again (now with correspondence info)
chr_grouped <- chromatogram(xdata, mz = c(305.05, 305.15))

# Plot with actual grouping
gplotChromPeakDensity(chr_grouped, simulate = FALSE) +
  ggtitle("Actual Correspondence Results")
```

# gplotChromatogramsOverlay: Overlay Visualization

The `gplotChromatogramsOverlay()` function creates overlay plots of multiple chromatograms, particularly useful for comparing extracted ion chromatograms (EICs).

## Single m/z Range

<div class="row">
<div class="col-md-6">

### Original XCMS Version

```{r original_overlay}
#| fig-height: 4
#| fig-width: 5
#| fig-alt: "XCMS plotChromatogramsOverlay showing all samples overlaid in a single plot. Each sample's chromatogram is drawn as a semi-transparent line, allowing visualization of retention time shifts and intensity differences across samples."
# Base R graphics version
plotChromatogramsOverlay(chr)
```

</div>
<div class="col-md-6">

### xcmsVis ggplot2 Version

```{r xcmsvis_overlay}
#| fig-height: 4
#| fig-width: 5
#| fig-alt: "ggplot2 version of the overlay plot with cleaner aesthetics, proper legend handling, and consistent theming with other xcmsVis functions."
# ggplot2 version
gplotChromatogramsOverlay(chr)
```

</div>
</div>

## Multiple m/z Ranges

When extracting chromatograms for multiple m/z ranges, `gplotChromatogramsOverlay()` creates a separate panel for each:

```{r multi_range_overlay}
#| fig-height: 8
#| fig-width: 8
#| fig-alt: "Two vertically stacked plots, each showing overlaid chromatograms for a different m/z range. This layout allows comparison of multiple compounds simultaneously."
# Extract chromatograms for two m/z ranges
chr_multi <- chromatogram(xdata, mz = rbind(
  c(305.05, 305.15),
  c(344.0, 344.2)
))

gplotChromatogramsOverlay(chr_multi, main = c("M305", "M344"))
```

## Stacked Visualization

For better visual separation, chromatograms can be vertically offset:

```{r stacked_overlay}
#| fig-height: 5
#| fig-width: 8
#| fig-alt: "Overlay plot with chromatograms vertically offset by a fixed amount. This stacking prevents overlapping traces and makes it easier to follow individual samples."
gplotChromatogramsOverlay(chr, stacked = 1e6) +
  ggtitle("Stacked Chromatograms (offset = 1e6)")
```

## Intensity Transformation

Apply transformations for better visualization of low-intensity features:

```{r transformed_overlay}
#| fig-height: 5
#| fig-width: 8
#| fig-alt: "Overlay plot with log-transformed intensities, making low-intensity peaks more visible while compressing the dynamic range of high-intensity peaks."
gplotChromatogramsOverlay(chr, transform = log1p) +
  ggtitle("Log-Transformed Intensities")
```

## Custom Colors and Peak Styles

```{r custom_styling}
#| fig-height: 5
#| fig-width: 8
#| fig-alt: "Overlay plot with custom colors for lines (blue) and peaks (red), demonstrating the flexibility of styling options."
gplotChromatogramsOverlay(
  chr,
  col = "blue",
  peakCol = "red",
  peakBg = "#ff000020",
  peakType = "rectangle"
) + ggtitle("Custom Styling")
```

# Complete Workflow Example

Here's a complete workflow demonstrating how these functions work together:

```{r complete_workflow}
#| fig-height: 12
#| fig-width: 10
#| fig-alt: "Three-panel figure showing a complete XCMS workflow. Top panel: peak density visualization for parameter optimization. Middle panel: overlay of all samples showing good alignment. Bottom panel: individual chromatogram with detected peaks marked."
# 1. Extract chromatogram
chr_workflow <- chromatogram(xdata, mz = c(344.0, 344.2))

# 2. Check peak density with different parameters
prm1 <- PeakDensityParam(sampleGroups = rep(1, 3), bw = 20)
prm2 <- PeakDensityParam(sampleGroups = rep(1, 3), bw = 40)

p1 <- gplotChromPeakDensity(chr_workflow, param = prm1) +
  ggtitle("Peak Density (bw=20)")

p2 <- gplotChromPeakDensity(chr_workflow, param = prm2) +
  ggtitle("Peak Density (bw=40)")

# 3. Overlay all samples
p3 <- gplotChromatogramsOverlay(chr_workflow) +
  ggtitle("All Samples Overlaid")

# 4. Individual chromatogram
p4 <- gplot(chr_workflow[1, 1]) +
  ggtitle("Sample 1 Detail")

# Combine all plots
(p1 | p2) / p3 / p4
```

# Interactive Exploration

All ggplot2 outputs can be converted to interactive plotly visualizations:

```{r interactive_complete}
#| fig-height: 6
#| fig-width: 10
#| fig-alt: "Interactive peak density plot with hover tooltips, zoom capabilities, and pan functionality for detailed exploration of peak grouping."
# Create interactive peak density plot
p <- gplotChromPeakDensity(chr, param = prm)
ggplotly(p)
```

# Summary

The chromatogram visualization functions in xcmsVis provide:

- **Consistent API**: All functions return ggplot objects that can be customized
- **Interactive capability**: Easy conversion to plotly for data exploration
- **Composition**: Use patchwork to combine multiple plots
- **Flexibility**: Extensive customization options for colors, styles, and transformations
- **Quality**: Publication-ready graphics with clean, modern aesthetics

These functions are particularly useful for:

1. **Parameter optimization**: `gplotChromPeakDensity()` helps tune correspondence parameters
2. **Quality control**: `gplotChromatogramsOverlay()` reveals retention time shifts and intensity variations
3. **Presentation**: All functions produce publication-quality figures
4. **Exploration**: Interactive plotly conversion enables detailed data inspection

# Session Info

```{r session_info}
sessionInfo()
```
