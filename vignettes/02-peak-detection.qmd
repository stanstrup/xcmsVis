---
title: "Step 2: Peak Detection Visualization"
author: "xcmsVis Package"
date: today
format:
  html:
    toc: true
    toc-location: left
    code-fold: false
    theme: cosmo
vignette: >
  %\VignetteIndexEntry{Step 2: Peak Detection Visualization}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

```{r setup}
#| include: false
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 6,
  warning = FALSE,
  message = FALSE
)
```

# Introduction

This vignette covers the **second step** in the XCMS metabolomics workflow: **visualizing detected chromatographic peaks**. After running `findChromPeaks()`, these functions help you:

- Assess peak detection quality
- Visualize peak distribution across samples
- Examine individual peak shapes
- Annotate chromatograms with detected peaks

## XCMS Workflow Context

```
┌───────────────────────────────┐
│ 1. Raw Data Visualization     │
├───────────────────────────────┤
│ 2. PEAK DETECTION             │ ← YOU ARE HERE
├───────────────────────────────┤
│ 3. Peak Correspondence        │
│ 4. Retention Time Alignment   │
│ 5. Feature Grouping           │
└───────────────────────────────┘
```

## Functions Covered

- **`gplotChromPeaks()`**: Visualize detected peaks as rectangles in RT vs m/z space
- **`gplotChromPeakImage()`**: Heatmap showing peak density across samples and retention time
- **`gplot(XChromatogram)`**: Plot individual chromatograms with detected peaks
- **`ghighlightChromPeaks()`**: Add peak annotations to existing chromatogram plots

# Setup

```{r libraries}
library(xcms)
library(ggplot2)
library(plotly)
library(faahKO)
library(MsExperiment)
library(BiocParallel)
library(patchwork)
library(xcmsVis)
```

# Data Preparation

We'll use pre-processed example data with peaks already detected:

```{r load_data}
# Load pre-processed data with detected peaks
# This dataset contains 248 detected peaks from 3 samples
xdata <- loadXcmsData("faahko_sub2")

# Add sample metadata for visualization
sampleData(xdata)$sample_name <- c("KO01", "KO02", "WT01")
sampleData(xdata)$sample_group <- c("KO", "KO", "WT")

# Check number of peaks detected
cat("Total peaks detected:", nrow(chromPeaks(xdata)), "\n")
```

# Part 1: Peak Distribution Visualization

## gplotChromPeaks(): Peak Rectangles in RT/m/z Space

The `gplotChromPeaks()` function creates a scatter plot showing detected peaks as rectangles in retention time vs m/z space.

### Basic Usage

```{r gplot_chrompeaks}
#| fig-height: 5
#| fig-width: 5
#| fig-alt: "ggplot2 version showing detected peaks as semi-transparent rectangles in RT vs m/z space."
gplotChromPeaks(xdata, file = 1)
```

### Focusing on a Region

```{r zoom_chrompeaks}
#| fig-height: 5
#| fig-width: 7
#| fig-alt: "Zoomed view of chromatographic peaks in a specific region."
# Focus on a specific RT and m/z region
gplotChromPeaks(
                xdata,
                file = 1,
                xlim = c(2600, 2750),
                ylim = c(325,460)
              )
```


### Customizing the Plot

```{r custom_chrompeaks}
#| fig-height: 5
#| fig-width: 7
#| fig-alt: "Customized chromatographic peaks plot with custom styling."
gplotChromPeaks(xdata, file = 1, 
                xlim = c(2600, 2750),
                ylim = c(325,460),
                border = "darkblue",
                fill = "lightblue"
                ) +
  labs(
    title = "Detected Peaks - Sample 1",
    x = "Retention Time (s)",
    y = "m/z"
  ) +
  theme_minimal()
```

### Comparing Multiple Samples

```{r compare_samples}
#| fig-height: 4
#| fig-width: 10
#| fig-alt: "Side-by-side comparison of peak distributions across three samples."
p_s1 <- gplotChromPeaks(xdata, file = 1) + labs(title = "Sample 1 (KO)")
p_s2 <- gplotChromPeaks(xdata, file = 2) + labs(title = "Sample 2 (KO)")
p_s3 <- gplotChromPeaks(xdata, file = 3) + labs(title = "Sample 3 (WT)")

p_s1 + p_s2 + p_s3
```

## gplotChromPeakImage(): Peak Density Heatmap

The `gplotChromPeakImage()` function creates a heatmap showing the number of detected peaks per sample across retention time bins.

### Basic Usage

```{r gplot_peakimage}
#| fig-height: 4
#| fig-width: 5
#| fig-alt: "ggplot2 heatmap of peak density using viridis color scale."
gplotChromPeakImage(xdata, binSize = 30)
```

### With Different Bin Sizes

```{r different_bins}
#| fig-height: 4
#| fig-width: 10
#| fig-alt: "Comparison of peak density heatmaps using different bin sizes."
p_b15 <- gplotChromPeakImage(xdata, binSize = 15) +
  labs(title = "Bin Size: 15s")
p_b30 <- gplotChromPeakImage(xdata, binSize = 30) +
  labs(title = "Bin Size: 30s")
p_b60 <- gplotChromPeakImage(xdata, binSize = 60) +
  labs(title = "Bin Size: 60s")

p_b15 + p_b30 + p_b60
```

### Log-Transformed View

```{r log_transform}
#| fig-height: 4
#| fig-width: 10
#| fig-alt: "Comparison of linear and log2-transformed peak density heatmaps."
p_linear <- gplotChromPeakImage(xdata, log_transform = FALSE) +
  labs(title = "Linear Scale")
p_log <- gplotChromPeakImage(xdata, log_transform = TRUE) +
  labs(title = "Log2 Scale")

p_linear + p_log
```

### Interactive Version

```{r interactive_peakimage}
#| fig-alt: "Interactive plotly version of peak density heatmap."
p3 <- gplotChromPeakImage(xdata, binSize = 30)
ggplotly(p3)
```

# Part 2: Chromatogram Visualization

## gplot(XChromatogram): Automatic Peak Plotting

First, let's extract a chromatogram for a specific m/z range:

```{r extract_chrom}
# Extract chromatogram for m/z 200-210
mz_range <- c(200, 210)
rt_range <- c(2500, 3500)

# Get chromatogram data
chr <- chromatogram(xdata, mz = mz_range, rt = rt_range)
```

```{r gplot_chromatogram}
#| fig-height: 5
#| fig-width: 5
#| fig-alt: "ggplot2 version of chromatogram plot with detected peaks automatically marked."
gplot(chr[1, 1]) +
  labs(title = "Chromatogram with Detected Peaks")
```

### Multiple Peak Types

```{r peak_types}
#| fig-height: 8
#| fig-width: 8
#| fig-alt: "Four panel plot showing different peak annotation styles."
p1 <- gplot(chr[1, 1], peakType = "polygon") + ggtitle("Polygon")
p2 <- gplot(chr[1, 1], peakType = "point") + ggtitle("Point")
p3 <- gplot(chr[1, 1], peakType = "rectangle") + ggtitle("Rectangle")
p4 <- gplot(chr[1, 1], peakType = "none") + ggtitle("None")

(p1 | p2) / (p3 | p4)
```

### Interactive Chromatogram

```{r interactive_gplot}
#| fig-height: 4
#| fig-width: 8
#| fig-alt: "Interactive plotly chromatogram."
ggplotly(gplot(chr[1, 1]))
```

# Part 3: Composable Peak Highlighting

## ghighlightChromPeaks(): Adding Peak Layers

For more control, `ghighlightChromPeaks()` returns ggplot2 layers that can be added to any chromatogram plot:

```{r highlight_rect}
#| fig-height: 5
#| fig-width: 5
#| fig-alt: "Chromatogram with detected peaks highlighted as semi-transparent rectangles."
# Start with gplot() which creates the chromatogram
p_chrom <- gplot(chr[1, 1], peakType = "none") +
  labs(
    title = "Chromatogram with Highlighted Peaks (Rectangle)",
    x = "Retention Time (s)",
    y = "Intensity"
  )

# Add peak highlights as rectangles
peak_layers <- ghighlightChromPeaks(
  xdata,
  rt = rt_range,
  mz = mz_range,
  type = "rect",
  border = "red",
  fill = alpha("red", 0.2)
)

# Combine base plot with peak annotations
p_chrom + peak_layers
```

## Understanding Peak Highlighting Behavior

The `ghighlightChromPeaks()` function searches **all peaks across all samples**. For cleaner visualization, filter to a single sample:

```{r highlight_filtered}
#| fig-height: 5
#| fig-width: 10
#| fig-alt: "Comparison showing peak highlighting with and without sample filtering."
# Without filtering: shows peaks from ALL samples
p_all <- gplot(chr[1, 1], peakType = "none") +
  ghighlightChromPeaks(xdata,
                       rt = rt_range,
                       mz = mz_range,
                       type = "rect",
                       border = "red",
                       fill = alpha("red", 0.2)) +
  labs(title = "All Samples (may show extra peaks)",
       x = "RT (s)", y = "Intensity")

# With filtering: shows only peaks from sample 1
xdata_filtered <- filterFile(xdata, 1)
p_filtered <- gplot(chr[1, 1], peakType = "none") +
  ghighlightChromPeaks(xdata_filtered,
                       rt = rt_range,
                       mz = mz_range,
                       type = "rect",
                       border = "blue",
                       fill = alpha("blue", 0.2)) +
  labs(title = "Single Sample (sample 1 only)",
       x = "RT (s)", y = "Intensity")

p_all + p_filtered
```

## Different Visualization Types

```{r highlight_types}
#| fig-height: 10
#| fig-width: 8
#| fig-alt: "Three-panel comparison showing different peak annotation styles."
xdata_filtered <- filterFile(xdata, 1)

# Type: Rectangle
p_rect <- gplot(chr[1, 1], peakType = "none") +
  labs(title = "Peak Annotations: Rectangles", x = "RT (s)", y = "Intensity")
peak_rects <- ghighlightChromPeaks(
  xdata_filtered,
  rt = rt_range,
  mz = mz_range,
  type = "rect",
  border = "red",
  fill = alpha("red", 0.2)
)

# Type: Point
p_point <- gplot(chr[1, 1], peakType = "none") +
  labs(title = "Peak Annotations: Points", x = "RT (s)", y = "Intensity")
peak_points <- ghighlightChromPeaks(
  xdata_filtered,
  rt = rt_range,
  mz = mz_range,
  type = "point",
  border = "red"
)

# Type: Polygon
p_poly <- gplot(chr[1, 1], peakType = "none") +
  labs(title = "Peak Annotations: Polygons", x = "RT (s)", y = "Intensity")
peak_polygons <- ghighlightChromPeaks(
  xdata_filtered,
  rt = rt_range,
  mz = mz_range,
  type = "polygon",
  border = "blue",
  fill = alpha("blue", 0.3)
)

# Display all three types
(p_rect + peak_rects) /
(p_point + peak_points) /
(p_poly + peak_polygons)
```

## Peak Selection Criteria

```{r peak_selection}
#| fig-height: 8
#| fig-width: 8
#| fig-alt: "Comparison of three peak selection methods."
# whichPeaks: "any" - peaks that overlap the range
p_any <- gplot(chr[1, 1], peakType = "none") +
  labs(title = "whichPeaks = 'any'", x = "RT (s)", y = "Intensity")

peaks_any <- ghighlightChromPeaks(
  xdata_filtered, rt = rt_range, mz = mz_range,
  whichPeaks = "any", border = "red", fill = alpha("red", 0.2)
)

# whichPeaks: "within" - peaks fully within the range
p_within <- gplot(chr[1, 1], peakType = "none") +
  labs(title = "whichPeaks = 'within'", x = "RT (s)", y = "Intensity")

peaks_within <- ghighlightChromPeaks(
  xdata_filtered, rt = rt_range, mz = mz_range,
  whichPeaks = "within", border = "blue", fill = alpha("blue", 0.2)
)

# whichPeaks: "apex_within" - peaks with apex in range
p_apex <- gplot(chr[1, 1], peakType = "none") +
  labs(title = "whichPeaks = 'apex_within'", x = "RT (s)", y = "Intensity")

peaks_apex <- ghighlightChromPeaks(
  xdata_filtered, rt = rt_range, mz = mz_range,
  whichPeaks = "apex_within", border = "green", fill = alpha("green", 0.2)
)

# Display comparison
(p_any + peaks_any) / (p_within + peaks_within) / (p_apex + peaks_apex)
```

# Combining Visualizations

Create comprehensive peak detection summaries:

```{r combined_view}
#| fig-height: 8
#| fig-width: 10
#| fig-alt: "Combined peak detection summary."
# Peak distribution for one sample
p_dist <- gplotChromPeaks(xdata, file = 1) +
  labs(title = "Peak Distribution - Sample 1")

# Peak density across all samples
p_density <- gplotChromPeakImage(xdata, binSize = 30) +
  labs(title = "Peak Density Across Samples")

# Combine
p_dist / p_density
```

# Summary

## Functions Covered

| Function | Purpose | Input |
|----------|---------|-------|
| `gplotChromPeaks()` | Show peaks in RT/m/z space | XcmsExperiment |
| `gplotChromPeakImage()` | Peak density heatmap | XcmsExperiment |
| `gplot(XChromatogram)` | Chromatogram with peaks | XChromatogram |
| `ghighlightChromPeaks()` | Add peak annotations | Layer for ggplot |

## Use Cases

- **Quality control**: Verify peak detection quality
- **Method development**: Optimize CentWave parameters
- **Sample comparison**: Compare peak detection across samples
- **Peak inspection**: Examine individual peak shapes

## Next Steps

After visualizing detected peaks, proceed to:

→ **[Step 3: Peak Correspondence](03-peak-correspondence.html)** - Group peaks across samples

# Comparison with Original XCMS

<div class="row">
<div class="col-md-6">

## Original XCMS

```{r original_chrompeaks}
#| fig-height: 5
#| fig-width: 5
#| fig-alt: "XCMS plotChromPeaks using base R graphics."
plotChromPeaks(xdata, file = 1, xlim = c(2600, 2750), ylim = c(325,460))
```

</div>
<div class="col-md-6">

## xcmsVis ggplot2

```{r ggplot_chrompeaks_supp}
#| fig-height: 5
#| fig-width: 5
#| fig-alt: "ggplot2 version with modern aesthetics."
gplotChromPeaks(xdata, file = 1, xlim = c(2600, 2750), ylim = c(325,460))
```

</div>
</div>

## gplotChromPeakImage() vs plotChromPeakImage()

<div class="row">
<div class="col-md-6">

### Original XCMS

```{r original_peakimage}
#| fig-height: 4
#| fig-width: 5
#| fig-alt: "XCMS plotChromPeakImage using base R graphics."
plotChromPeakImage(xdata, binSize = 30)
```

</div>
<div class="col-md-6">

### xcmsVis ggplot2

```{r xcmsvis_peakimage}
#| fig-height: 4
#| fig-width: 5
#| fig-alt: "ggplot2 version with viridis color scale."
gplotChromPeakImage(xdata, binSize = 30)
```

</div>
</div>

## gplot(XChromatogram) vs plot(Chromatogram)

<div class="row">
<div class="col-md-6">

### Original XCMS

```{r original_chromatogram}
#| fig-height: 5
#| fig-width: 5
#| fig-alt: "XCMS plot for Chromatogram using base R graphics."
plot(chr[1, 1])
```

</div>
<div class="col-md-6">

### xcmsVis ggplot2

```{r xcmsvis_chromatogram}
#| fig-height: 5
#| fig-width: 5
#| fig-alt: "ggplot2 version with detected peaks."
gplot(chr[1, 1])
```

</div>
</div>

## ghighlightChromPeaks() vs highlightChromPeaks()

<div class="row">
<div class="col-md-6">

### Original XCMS

```{r original_highlight}
#| fig-height: 5
#| fig-width: 5
#| fig-alt: "XCMS highlightChromPeaks using base R graphics."
xdata_filtered <- filterFile(xdata, 1)
# Convert to XCMSnExp for original XCMS function
xdata_xcmsnexp <- as(xdata_filtered, "XCMSnExp")
plot(chr[1, 1])
highlightChromPeaks(xdata_xcmsnexp, rt = rt_range, mz = mz_range,
                    type = "rect", border = "red")
```

</div>
<div class="col-md-6">

### xcmsVis ggplot2

```{r xcmsvis_highlight}
#| fig-height: 5
#| fig-width: 5
#| fig-alt: "ggplot2 version as composable layers."
gplot(chr[1, 1], peakType = "none") +
  ghighlightChromPeaks(xdata_filtered, rt = rt_range, mz = mz_range,
                       type = "rect", border = "red", fill = alpha("red", 0.2))
```

</div>
</div>

# Session Info

```{r session_info}
sessionInfo()
```
