---
title: "Visualizing XcmsExperiment MS Data"
author: "xcmsVis Package"
date: today
format:
  html:
    toc: true
    toc-location: left
    code-fold: false
    theme: cosmo
vignette: >
  %\VignetteIndexEntry{Visualizing XcmsExperiment MS Data}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

```{r setup}
#| include: false
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 10,
  fig.height = 8,
  warning = FALSE,
  message = FALSE
)
```

# Introduction

This vignette demonstrates the `gplot()` function for visualizing XcmsExperiment and XCMSnExp objects. The `gplot()` method creates a two-panel visualization showing:

- **Upper panel**: Base Peak Intensity (BPI) chromatogram vs retention time
- **Lower panel**: m/z vs retention time scatter plot

Both panels use intensity-based coloring to highlight signal strength, and detected peaks are automatically overlaid as rectangles.

This is a ggplot2 reimplementation of XCMS's `plot()` method for MsExperiment objects, enabling modern visualization capabilities including:

- Interactive plots with plotly
- Customizable color schemes
- Easy composition with patchwork
- Publication-quality graphics

# Setup

```{r libraries}
library(xcms)
library(xcmsVis)
library(ggplot2)
library(plotly)
library(patchwork)
```

# Data Preparation

We'll use pre-processed test data from XCMS for demonstration:

```{r load_data}
# Load pre-processed data with detected peaks
xdata <- loadXcmsData("faahko_sub2")

# Check data
cat("Samples:", length(xdata), "\n")
cat("Total peaks detected:", nrow(chromPeaks(xdata)), "\n")
```

For visualization purposes, we'll filter to a specific retention time and m/z region:

```{r filter_data}
# Filter to focused region
mse <- filterRt(xdata, rt = c(2500, 2800))
mse <- filterMzRange(mse, mz = c(218, 220.5))

cat("Filtered data:\n")
cat("  RT range:", paste(range(rtime(spectra(mse[1]))), collapse = " - "), "\n")
cat("  Number of spectra in sample 1:", length(spectra(mse[1])), "\n")
```

# Basic Usage

## Single Sample Visualization

The most basic usage is to plot a single sample:

```{r gplot_basic}
#| fig-height: 6
#| fig-width: 8
#| fig-alt: "Two-panel plot showing BPI chromatogram (upper panel) and m/z vs retention time scatter plot (lower panel) with intensity-based coloring."
gplot(mse[1])
```

## Understanding the Two Panels

The visualization consists of two complementary views:

### Upper Panel: BPI Chromatogram

The **Base Peak Intensity (BPI)** shows the maximum intensity at each retention time across all m/z values in the filtered range. This gives an overview of when signals are present in the chromatogram.

- Each point represents one retention time
- Y-axis shows the maximum intensity observed at that time
- Color indicates intensity magnitude
- Useful for identifying retention time regions with strong signals

### Lower Panel: m/z vs RT Scatter

The **m/z vs retention time scatter** shows the complete mass spectral data:

- X-axis: retention time
- Y-axis: m/z values
- Each point represents one data point from the raw spectra
- Color indicates intensity of that specific m/z at that retention time
- Shows the full two-dimensional structure of the LC-MS data

### Peak Overlays

If chromatographic peaks have been detected (via `findChromPeaks()`), they are automatically overlaid as rectangles showing:

- Peak retention time boundaries (left/right edges)
- Peak m/z boundaries (top/bottom edges)
- Semi-transparent red color by default

# Multiple Samples

When visualizing multiple samples, `gplot()` creates a vertically stacked layout:

```{r multiple_samples}
#| fig-height: 12
#| fig-width: 8
#| fig-alt: "Three sets of two-panel plots stacked vertically, one for each sample, showing BPI and m/z scatter plots."
# Plot all three samples
gplot(mse)
```

Each sample gets its own two-panel visualization, making it easy to compare across samples.

# Customization

## Custom Colors

You can customize the line colors and peak colors:

```{r custom_colors}
#| fig-height: 6
#| fig-width: 8
#| fig-alt: "Two-panel plot with blue point borders and red peak rectangles, demonstrating color customization."
gplot(mse[1],
      col = "blue",           # Point border color
      peakCol = "red")        # Peak rectangle color
```

## Custom Color Ramps

The intensity coloring uses a color ramp function. You can use any R color ramp:

```{r color_ramps}
#| fig-height: 12
#| fig-width: 10
#| fig-alt: "Three side-by-side plots showing different color ramps: topo.colors (default), viridis, and magma."
# Default: topo.colors
p1 <- gplot(mse[1]) +
  ggtitle("topo.colors (default)")

# Viridis (reversed for low=dark, high=bright)
library(viridisLite)
viridis_rev <- function(n) rev(viridis(n))
p2 <- gplot(mse[1], colramp = viridis_rev) +
  ggtitle("viridis (reversed)")

# Magma (reversed)
magma_rev <- function(n) rev(magma(n))
p3 <- gplot(mse[1], colramp = magma_rev) +
  ggtitle("magma (reversed)")

(p1 | p2 | p3)
```

::: {.callout-tip}
## Color Scale Direction

For MS data, it's conventional to have **low intensity = dark** and **high intensity = bright**.
The viridis scales are reversed (`rev(viridis(n))`) to follow this convention, where:

- Dark purple/black = low intensity (noise, baseline)
- Bright yellow = high intensity (strong signals)

This makes it easier to identify strong signals at a glance.
:::

### More Viridis Palettes

The viridisLite package provides several perceptually-uniform color scales:

```{r viridis_palettes}
#| fig-height: 6
#| fig-width: 12
#| fig-alt: "Four plots showing different viridis palette options: viridis, magma, plasma, and inferno."
library(viridisLite)

# Create reversed versions for MS convention
viridis_rev <- function(n) rev(viridis(n))
magma_rev <- function(n) rev(magma(n))
plasma_rev <- function(n) rev(plasma(n))
inferno_rev <- function(n) rev(inferno(n))

p1 <- gplot(mse[1], colramp = viridis_rev) + ggtitle("Viridis")
p2 <- gplot(mse[1], colramp = magma_rev) + ggtitle("Magma")
p3 <- gplot(mse[1], colramp = plasma_rev) + ggtitle("Plasma")
p4 <- gplot(mse[1], colramp = inferno_rev) + ggtitle("Inferno")

(p1 | p2) / (p3 | p4)
```

**Choosing a palette:**

- **Viridis**: Good general-purpose, colorblind-friendly
- **Magma**: High contrast, good for presentations
- **Plasma**: Vibrant, good for highlighting features
- **Inferno**: Warm colors, good for print

All viridis palettes are:
- Perceptually uniform (equal steps appear equal)
- Colorblind-friendly
- Print-friendly (grayscale conversion works well)

## Custom Titles

Provide custom titles for each sample:

```{r custom_titles}
#| fig-height: 12
#| fig-width: 8
#| fig-alt: "Three stacked two-panel plots with custom sample names as titles."
# Custom sample names
gplot(mse, main = c("Knockout 1", "Knockout 2", "Wild Type"))
```

## Point Styles

Customize the point shape using standard R `pch` values:

```{r point_styles}
#| fig-height: 6
#| fig-width: 10
#| fig-alt: "Two plots side by side showing different point shapes: filled circles (pch=21) and filled squares (pch=22)."
p1 <- gplot(mse[1], pch = 21) + ggtitle("Filled circles (pch = 21)")
p2 <- gplot(mse[1], pch = 22) + ggtitle("Filled squares (pch = 22)")

p1 | p2
```

# Interactive Visualization

Convert to interactive plotly for data exploration:

```{r interactive}
#| fig-height: 8
#| fig-width: 10
#| fig-alt: "Interactive plotly version with hover tooltips, zoom, and pan capabilities for detailed data exploration."
# Create static ggplot
p <- gplot(mse[1])

# Convert to interactive plotly
ggplotly(p)
```

The interactive version allows you to:

- **Hover** over points to see exact values
- **Zoom** into regions of interest
- **Pan** to explore different areas
- **Toggle** legend items to focus on specific features

## Accessing Individual Panels

When `gplot()` returns a patchwork object, `ggplotly()` only converts the last panel to interactive. To access individual panels for interactive conversion, use list indexing:

```{r interactive_panels}
#| eval: false
# Create the plot
p <- gplot(mse[1])

# Access and convert individual panels
ggplotly(p[[1]])  # Upper panel (BPI chromatogram) - interactive
ggplotly(p[[2]])  # Lower panel (m/z scatter) - interactive
```

This approach gives you full interactive control over each panel separately, which can be useful when you want to:

- Examine the BPI chromatogram in detail
- Zoom into specific m/z regions in the scatter plot
- Export individual panels as interactive HTML widgets

**Note:** For patchwork objects with multiple samples, use `p[[i]]` to access each sample's plot, where `i` is the sample number. Each sample plot itself contains two panels that can be further accessed with `p[[i]][[j]]` where `j` is 1 for BPI or 2 for m/z scatter.

# Advanced Workflows

## Comparing Different MS Levels

This example uses data from MetaboLights (MTBLS8735) that contains both MS1 and MS2 data:

```{r ms_levels}
#| eval: false
# Load MS2 data from MetaboLights
library(MetaboLights)
library(MsExperiment)

param <- MetaboLightsParam(mtblsId = "MTBLS8735",
                           assayName = paste0("a_MTBLS8735_LC-MSMS_positive_",
                                            "hilic_metabolite_profiling.txt"),
                           filePattern = "MSMS_2_(E|A).*\\.mzML")

lcms2 <- readMsObject(MsExperiment(),
                     param,
                     keepOntology = FALSE,
                     keepProtocol = FALSE,
                     simplify = TRUE)

# Filter to a sensible range
lcms2_filtered <- filterRt(lcms2, rt = c(50, 150))
lcms2_filtered <- filterMzRange(lcms2_filtered, mz = c(200, 400))

# MS1 data (default)
p_ms1 <- gplot(lcms2_filtered[1], msLevel = 1L) + ggtitle("MS1")

# MS2 data
p_ms2 <- gplot(lcms2_filtered[1], msLevel = 2L) + ggtitle("MS2")

p_ms1 / p_ms2
```

This demonstrates how `gplot()` can visualize different MS levels in the same experiment, useful for examining fragmentation patterns alongside precursor ions.

## Focused Region Analysis

Combine filtering with visualization for detailed inspection:

```{r focused_region}
#| fig-height: 6
#| fig-width: 8
#| fig-alt: "Highly zoomed plot showing a very narrow retention time window for detailed peak analysis."
# Focus on narrow RT window
mse_focused <- filterRt(xdata, rt = c(2700, 2820))
mse_focused <- filterMzRange(mse_focused, mz = c(204, 208))

gplot(mse_focused[1]) +
  ggtitle("Focused: RT 2700-2820, m/z 204-208")
```

## Comparing Samples

Create a comprehensive comparison across all samples:

```{r sample_comparison}
#| fig-height: 14
#| fig-width: 12
#| fig-alt: "Multi-panel figure comparing all three samples with consistent scales and styling."
# Filter to consistent region
mse_compare <- filterRt(xdata, rt = c(2600, 2800))
mse_compare <- filterMzRange(mse_compare, mz = c(206, 209))

# Plot all samples with custom titles
gplot(mse_compare,
      main = c("Sample A (KO)", "Sample B (KO)", "Sample C (WT)"),
      peakCol = "#ff000080")
```

# Integration with Other Packages

## Custom ggplot2 Modifications

Add additional ggplot2 layers or modify themes. Use the `&` operator to apply themes to all panels in the patchwork object:

```{r custom_ggplot}
#| fig-height: 6
#| fig-width: 8
#| fig-alt: "gplot output with custom theme modifications and additional annotations."
gplot(mse[1]) &
  theme_minimal() &
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold", size = 14)
  )
```

::: {.callout-note}
## Patchwork Operators

Since `gplot()` returns a patchwork object (two panels combined), use:

- `&` operator to apply themes/scales to **all panels**
- `+` operator to add individual layers (but may cause issues with multi-panel plots)

For single-panel plots, both work. For multi-panel patchwork objects, `&` is safer.
:::

# Use Cases

## Quality Control

Visualize raw MS data to check for:

- Signal intensity across retention time
- Presence of expected m/z ranges
- Peak detection quality
- Sample-to-sample consistency

```{r qc_example}
#| fig-height: 12
#| fig-width: 10
#| fig-alt: "QC visualization showing all three samples for comparison of data quality."
# QC check: visualize all samples in a batch
gplot(mse, main = paste("QC:", c("Sample 1", "Sample 2", "Sample 3")))
```

## Method Development

During method development, use `gplot()` to:

- Evaluate extraction efficiency across m/z ranges
- Optimize retention time windows
- Assess peak shapes and detection

## Publication Figures

Create publication-ready figures with custom styling:

```{r publication_example}
#| fig-height: 6
#| fig-width: 8
#| fig-alt: "Publication-quality figure with clean aesthetics and appropriate sizing."
# Use reversed viridis for conventional MS coloring
viridis_rev <- function(n) rev(viridis(n))

gplot(mse[1],
      main = "LC-MS Analysis: Sample KO15",
      col = "black",
      peakCol = "#d62728",
      colramp = viridis_rev) +
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    text = element_text(size = 12),
    legend.position = "right"
  )
```

# Performance Considerations

For large datasets, consider:

1. **Filter first**: Use `filterRt()` and `filterMzRange()` to reduce data size
2. **Subset samples**: Plot one sample at a time for interactive work
3. **Static plots**: Use static ggplot2 for final figures (faster than plotly)

```{r performance_tips}
#| eval: false
# Good: Filter to focused region
mse_small <- filterRt(large_data, rt = c(100, 200))
mse_small <- filterMzRange(mse_small, mz = c(200, 300))
gplot(mse_small[1])

# Avoid: Plotting huge unfiltered datasets
# gplot(large_data)  # May be slow
```

# Summary

The `gplot()` function for XcmsExperiment provides:

- **Two-panel visualization**: BPI chromatogram + m/z scatter
- **Automatic peak overlay**: Shows detected peaks as rectangles
- **Intensity coloring**: Highlights signal strength across the data
- **Full customization**: Colors, themes, point styles
- **Interactivity**: Easy conversion to plotly
- **Composition**: Integrates with patchwork and ggplot2 ecosystem

## Key Functions

| Function | Purpose | Input |
|----------|---------|-------|
| `gplot(XcmsExperiment)` | Visualize full MS data | XcmsExperiment object |
| `gplot(XChromatogram)` | Visualize EIC | XChromatogram object |
| `gplotChromPeaks()` | Show peaks in RT/m/z space | XcmsExperiment object |
| `gplotChromPeakDensity()` | Optimize correspondence | XChromatograms object |

## When to Use Each

- **`gplot(XcmsExperiment)`**: Explore raw MS acquisitions, QC, method development
- **`gplot(XChromatogram)`**: Analyze specific compounds, peak integration
- **`gplotChromPeaks()`**: Overview all detected peaks, retention time distribution
- **`gplotChromPeakDensity()`**: Optimize peak grouping parameters

# Supplementary: Comparison with Original XCMS

This supplementary section provides side-by-side comparisons between the original XCMS base R plotting functions and the new xcmsVis ggplot2-based implementations. These comparisons are useful for developers and users migrating from the original XCMS plotting functions.

## gplot() vs plot()

### Basic Single Sample Plot

<div class="row">
<div class="col-md-6">

#### XCMS plot()

```{r supp_xcms_basic}
#| fig-height: 6
#| fig-width: 5
#| fig-alt: "XCMS base R plot showing two panels: upper panel displays BPI chromatogram, lower panel shows m/z vs retention time scatter plot with intensity colors."
# Base R graphics version
plot(mse[1])
```

**Characteristics:**
- Base R graphics
- Fixed styling
- Static output
- Direct to graphics device

</div>
<div class="col-md-6">

#### xcmsVis gplot()

```{r supp_xcmsvis_basic}
#| fig-height: 6
#| fig-width: 5
#| fig-alt: "ggplot2 version of the same two-panel plot with cleaner aesthetics, shared legend, and modern styling."
# ggplot2 version
gplot(mse[1])
```

**Characteristics:**
- ggplot2 graphics
- Fully customizable
- Supports interactivity
- Returns ggplot object

</div>
</div>

### With Custom Styling

<div class="row">
<div class="col-md-6">

#### XCMS plot()

```{r supp_xcms_styled}
#| fig-height: 6
#| fig-width: 5
#| fig-alt: "XCMS base R plot with custom colors applied."
# Base R version with custom colors
plot(mse[1], col = "blue", peakCol = "red")
```

</div>
<div class="col-md-6">

#### xcmsVis gplot()

```{r supp_xcmsvis_styled}
#| fig-height: 6
#| fig-width: 5
#| fig-alt: "ggplot2 version with custom colors and additional theme modifications."
# ggplot2 version with custom colors and theme
gplot(mse[1], col = "blue", peakCol = "red") &
  theme_minimal()
```

</div>
</div>

## Feature Comparison Table

| Feature | XCMS `plot()` | xcmsVis `gplot()` |
|---------|---------------|-------------------|
| Graphics system | Base R | ggplot2 |
| Customization | Limited | Extensive via ggplot2 |
| Interactivity | None | Via plotly |
| Composition | Difficult | Easy with patchwork |
| Return value | NULL (side effect) | ggplot/patchwork object |
| Theme support | No | Yes (full ggplot2 themes) |
| Export quality | Good | Publication-ready |
| Color scales | Fixed | Fully customizable |
| Point styles | Limited | Full pch support |
| Multi-sample | Fixed layout | Flexible with patchwork |
| Adding layers | Not possible | Via `+` or `&` operators |

## All Plot Types Comparison

### XcmsExperiment Visualization (Full MS Data)

<div class="row">
<div class="col-md-6">

#### XCMS plot(XcmsExperiment)

```{r supp_xcms_experiment}
#| fig-height: 6
#| fig-width: 5
#| fig-alt: "XCMS base R plot showing full MS data: BPI and m/z scatter."
# Base R version
plot(mse[1])
```

Shows **raw MS data** (all m/z vs RT)

**Use when:**
- Exploring raw MS data
- Quality control of acquisitions
- Understanding full spectral information

</div>
<div class="col-md-6">

#### xcmsVis gplot(XcmsExperiment)

```{r supp_xcmsvis_experiment}
#| fig-height: 6
#| fig-width: 5
#| fig-alt: "ggplot2 version showing full MS data with modern aesthetics."
# ggplot2 version
gplot(mse[1])
```

Shows **raw MS data** (all m/z vs RT)

**Additional capabilities:**
- Interactive with plotly
- Custom color ramps
- Theme customization

</div>
</div>

### Chromatogram Visualization (EIC)

<div class="row">
<div class="col-md-6">

#### XCMS plot(XChromatogram)

```{r supp_xcms_chromatogram}
#| fig-height: 6
#| fig-width: 5
#| fig-alt: "XCMS base R chromatogram showing intensity vs retention time."
# Base R chromatogram
chr <- chromatogram(xdata, mz = c(207, 208), rt = c(2600, 2800))
plot(chr[1, 1])
```

Shows **extracted ion chromatogram (EIC)**

**Use when:**
- Focusing on specific m/z
- Peak integration
- Comparing specific compounds

</div>
<div class="col-md-6">

#### xcmsVis gplot(XChromatogram)

```{r supp_xcmsvis_chromatogram}
#| fig-height: 6
#| fig-width: 5
#| fig-alt: "ggplot2 chromatogram with enhanced styling and customization."
# ggplot2 chromatogram
chr <- chromatogram(xdata, mz = c(207, 208), rt = c(2600, 2800))
gplot(chr[1, 1])
```

Shows **extracted ion chromatogram (EIC)**

**Additional capabilities:**
- ggplot2 styling
- Easy faceting for multiple samples
- Interactive tooltips

</div>
</div>

### Multiple Samples

<div class="row">
<div class="col-md-6">

#### XCMS plot()

```{r supp_xcms_multi}
#| fig-height: 12
#| fig-width: 5
#| fig-alt: "XCMS base R plot with multiple samples in fixed layout."
# Base R version - fixed layout
plot(mse)
```

Fixed vertical stacking

</div>
<div class="col-md-6">

#### xcmsVis gplot()

```{r supp_xcmsvis_multi}
#| fig-height: 12
#| fig-width: 5
#| fig-alt: "ggplot2 version with multiple samples in flexible patchwork layout."
# ggplot2 version - flexible with patchwork
gplot(mse)
```

Flexible layout with patchwork operators

</div>
</div>

## Key Advantages of xcmsVis

### 1. Interactivity

```{r supp_interactive_demo}
#| fig-height: 6
#| fig-width: 8
#| fig-alt: "Interactive plotly version demonstrating hover tooltips and zoom capabilities."
# Convert to interactive plotly
p <- gplot(mse[1])
ggplotly(p)
```

The ggplot2 foundation allows seamless conversion to interactive plotly plots with hover information, zoom, and pan capabilities.

### 2. Composition

```{r supp_composition_demo}
#| fig-height: 6
#| fig-width: 12
#| fig-alt: "Side-by-side comparison using patchwork composition."
# Easy side-by-side comparison with patchwork
p1 <- gplot(mse[1]) + ggtitle("Sample 1")
p2 <- gplot(mse[2]) + ggtitle("Sample 2")
p1 | p2
```

Patchwork integration makes it trivial to create custom layouts and comparisons.

### 3. Theme Consistency

```{r supp_theme_demo}
#| fig-height: 6
#| fig-width: 12
#| fig-alt: "Multiple plots with consistent custom theme applied."
# Apply consistent theme across all plots
my_theme <- theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "bottom"
  )

gplot(mse[1]) & my_theme
```

Use the `&` operator to apply themes consistently across all panels in a patchwork object.

## Migration Guide

For users transitioning from XCMS `plot()` to xcmsVis `gplot()`:

### Basic Replacement

```r
# Old XCMS
plot(mse[1])

# New xcmsVis
gplot(mse[1])
```

### With Color Customization

```r
# Old XCMS
plot(mse[1], col = "blue", peakCol = "red")

# New xcmsVis (same syntax)
gplot(mse[1], col = "blue", peakCol = "red")
```

### Saving Plots

```r
# Old XCMS - must use graphics device
pdf("plot.pdf", width = 5, height = 6)
plot(mse[1])
dev.off()

# New xcmsVis - save ggplot object
p <- gplot(mse[1])
ggsave("plot.pdf", p, width = 5, height = 6)
```

### Further Customization

```r
# Old XCMS - limited customization
plot(mse[1], col = "blue")

# New xcmsVis - full ggplot2 ecosystem
gplot(mse[1], col = "blue") &
  theme_minimal() &
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold")
  )
```

## When to Use Each

**Use XCMS `plot()`** when:
- You need exact reproduction of legacy figures
- Working with base R graphics pipelines
- No customization needed

**Use xcmsVis `gplot()`** when:
- Creating publication figures with custom styling
- Building interactive visualizations
- Composing complex multi-panel figures
- Integrating with modern R visualization workflows
- Teaching or presentations (plotly interactivity)

# Session Info

```{r session_info}
sessionInfo()
```
